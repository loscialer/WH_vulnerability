library("patchwork")
library('stargazer')
library('VGAM')
library('ggsci')
library('binom')
library("ggpubr")
library("forcats")
library("gplots")
library("latticeExtra")
library("grid")
library("vcd")
library("corrplot")
library("stats")
library("ggrepel")
library("brms")
library("extrafont")
library("hrbrthemes")
library("statmod")
library('wordcloud2')
library('ggfortify')
library('DHARMa')
library('sjPlot')
library('emmeans')
library('ggeffects')
library('broom.mixed')
library('effects')
library('knitr')
library('MASS')
library('MuMIn')
library('emmeans')
library('ggsci')
library('glmmTMB')
library('sjPlot')
library('stargazer')
library('ResourceSelection')
library("tidyverse")
library('here')
library('reshape2')
library('RColorBrewer')
# Here
here('Data/experts.csv')

# Functions
stderr <- function(x, na.rm=FALSE){
  if (na.rm) x <- na.omit(x)
  sqrt(var(x)/length(x))
}

rescale_6_to_5 <- function(x) {
  y = (x/6)*5
  return(y)}

rescale_3_to_5 <- function(x) {
  y = (x/3)*5
  return(y)}


# Preliminary Work
# Open file

scientist <- read.csv('../Data/experts.csv')

### Change all character and logical vectors to factors

scientist[sapply(scientist, is.character)] <- lapply(scientist[sapply(scientist, is.character)], 
                                                     as.factor)
scientist[sapply(scientist, is.logical)] <- lapply(scientist[sapply(scientist, is.logical)], 
                                                   as.factor)



scientist <- scientist %>% mutate(across(.cols = matches("^sp_.{2,}_b[1-6]$"),
                                         ~ recode_factor(.x, 'X < 1 km^2' = '1',
                                                         '1 ? X < 10 km^2' = '2',
                                                         '10 ? X < 100 km^2' = '3', 
                                                         '100 ? X < 1,000 km ^2' = '4',
                                                         '1,000 ? X < 10,000 km^2' = '5',
                                                         'X ? 10,000 km^2' = '6'))) %>% 
  mutate(across(.cols = matches("^fr_.{2,}_b[1-6]$"), 
                ~ recode_factor(.x, 
                                'Never occurs' = '1', 
                                'Intermittent' = '2', 
                                'Occasional' = '3', 
                                'Frequent' = '4', 
                                'Ongoing' = '5' ))) %>% 
  mutate(across(.cols = matches("^tr_.{2,}_b[1-6]$"),
                ~ recode_factor(.x, 'Decreasing' = '1', 
                                'Stable' = '2',
                                'Increasing' = '3'))) %>% 
  mutate(across(.cols = matches("^fi_.{2,}_b[1-6]$"), 
                ~ recode_factor(.x, "No Impact" = '1', 
                                'Spp. at geographic limit' = '2', 
                                '? 25% of species' = '3',
                                '25 < X ? 50% of species' = '4', 
                                '50 < X ? 100% of species' = '5'))) %>% 
  mutate(across(.cols = matches("^res_.{2,}_b[1-6]$"), 
                ~ recode_factor(.x, "Low resistance" = '3', 
                                'Medium resistance' = '2', 
                                'High resistance' = '1'))) %>% 
  mutate(across(.cols = matches("^rec_.{2,}_b[1-6]$"), 
                ~ recode_factor(.x, "No Impact" = '1', 
                                'X ? 1 year' = '2', 
                                '1 < X ? 10 years' = '3',
                                '10 < X ? 100 years' = '4', 
                                'X > 100 years' = '5'))) %>% 
  mutate(across(.cols = matches('.*_cer$'),
                ~ recode_factor(.x, 'Low' = '1', 
                                'Medium' = '2',
                                'High' = '3',
                                'Very High' = '4')))


## Reconvert them to numbers

scientist <- scientist %>% mutate(across(.cols = sp_sst_b1:rec_others_b52, ~ as.numeric(as.character(.x))))



## Rescale sp, fr, tr, fi, res , rec (1-5)

scientist <- scientist %>% mutate(across(matches('^sp_.{2,}_b[1-6]$'), 
                                         ~ rescale_6_to_5(.x))) %>%
  mutate(across(matches('^(tr|res)_.{2,}_b[1-6]$'), 
                ~ rescale_3_to_5(.x)))
# Calculate weighted scores for Exposure

## Spatial scale

sp <- scientist %>% select(matches('^sp_.{2,}_b[1-6]')) %>% select(-contains('other'))
# Make NA values as 0
sp[is.na(sp)] <- 0
col_sp <-seq(1,ncol(sp),by=2)
weighted_sp <- mapply(weighted.mean,sp[,col_sp],sp[,-col_sp],MoreArgs=list(paired=TRUE))
sp_df <- data.frame(as.list(weighted_sp))



## Frequency

fr <- scientist %>% select(matches('^fr_.{2,}_b[1-6]')) %>% select(-contains('other'))
# Make NA values as 0
fr[is.na(fr)] <- 0
col_fr <-seq(1,ncol(fr),by=2)
weighted_fr <- mapply(weighted.mean,fr[,col_fr],fr[,-col_fr],MoreArgs=list(paired=TRUE))
fr_df <- data.frame(as.list(weighted_fr))



## Trend

tr <- scientist %>% select(matches('^tr_.{2,}_b[1-6]')) %>% select(-contains('other'))
# Make NA values as 0
tr[is.na(tr)] <- 0
col_tr <-seq(1,ncol(tr),by=2)
weighted_tr <- mapply(weighted.mean,tr[,col_tr],tr[,-col_tr],MoreArgs=list(paired=TRUE))
tr_df <- data.frame(as.list(weighted_tr))


## Certainty dataset
cer <- scientist %>% select(matches('.*_cer$')) %>% select(-contains('other'))
colnames(cer) <- sub("_cer", "", colnames(cer))

cer_long <- cer %>% 
  select(sp_sst_b1:rec_drg_b6) %>% 
  pivot_longer(everything(), 
               names_to = c('index','threat','bioregion'), 
               names_pattern = '(.*)_(.*)_(b[1-6])', 
               values_to = 'certainty') %>% 
  filter(!is.na(certainty))

bio_cer <- cer_long %>% 
  group_by(bioregion) %>% 
  summarise(mean = round(mean(certainty),2),
            SE = round(stderr(certainty),2))

bio_cer <- bio_cer %>% mutate(certainty = round(mean,0),
                              certainty_q = ifelse(certainty == 1, 'Low',
                                                   ifelse(certainty == 2, 'Medium',
                                                          ifelse(certainty == 3, 'High', 'Very high'))))
th_cer <- cer_long %>% 
  group_by(threat) %>% 
  summarise(mean = round(mean(certainty),2),
            SE = round(stderr(certainty),2))

th_cer <- th_cer %>% mutate(certainty = round(mean,0),
                            certainty_q = ifelse(certainty == 1, 'Low',
                                                 ifelse(certainty == 2, 'Medium',
                                                        ifelse(certainty == 3, 'High', 'Very high'))))
in_cer <- cer_long %>% 
  group_by(index) %>% 
  summarise(mean = round(mean(certainty),2),
            SE = round(stderr(certainty),2))

in_cer <- in_cer %>% mutate(certainty = round(mean,0),
                            certainty_q = ifelse(certainty == 1, 'Low',
                                                 ifelse(certainty == 2, 'Medium',
                                                        ifelse(certainty == 3, 'High', 'Very high'))))
top_cer <- cer_long %>% 
  group_by(threat, bioregion) %>% 
  summarise(mean = round(mean(certainty),2),
            SE = round(stderr(certainty),2)) %>% arrange(desc(mean)) %>% head(10)
tot_cer <- cer_long %>% 
  group_by(index, threat, bioregion) %>% 
  summarise(mean = round(mean(certainty),2),
            SE = round(stderr(certainty),2)) %>% arrange(desc(mean))
tot_cer <- tot_cer %>% mutate(cer_q = ifelse(mean >= 3.5, 'Very High',
                                             ifelse(mean >= 2.5 & mean <3.5, 'High',
                                                    ifelse(mean >=1.5 & mean < 2.5, 'Medium', 'Low'))))

cer_3_b1 <- tot_cer %>% filter(bioregion == 'b1') %>% arrange(desc(mean)) %>% head(3)
cer_3_b2 <- tot_cer %>% filter(bioregion == 'b2') %>% arrange(desc(mean)) %>% head(3)
cer_3_b3 <- tot_cer %>% filter(bioregion == 'b3') %>% arrange(desc(mean)) %>% head(3)
cer_3_b4 <- tot_cer %>% filter(bioregion == 'b4') %>% arrange(desc(mean)) %>% head(3)
cer_3_b5 <- tot_cer %>% filter(bioregion == 'b5') %>% arrange(desc(mean)) %>% head(3)
cer_3_b6 <- tot_cer %>% filter(bioregion == 'b6') %>% arrange(desc(mean)) %>% head(3)


## Exposure dataset

colnames(sp_df) <- sub("sp_", "", colnames(sp_df))
colnames(fr_df) <- sub("fr_", "", colnames(fr_df))
colnames(tr_df) <- sub("tr_", "", colnames(tr_df))



ex_df <- bind_rows(sp_df, fr_df, tr_df)
index <- c('sp','fr','tr')
ex_df$index <- index
ex_df <- ex_df %>% mutate(index = as.factor(index))
ex_df_long <- ex_df %>% pivot_longer(sst_b1:drg_b6, names_to = c('threat','bioregion'),
                                     names_pattern = '(.*)_(b[1-6])', values_to = 'value')

ex_df_long <- ex_df_long %>% mutate(threat = as.factor(threat),
                                    bioregion = as.factor(bioregion))
exposure <- ex_df_long %>% group_by(threat, bioregion) %>% summarise(exposure = mean(value))
exposure <- exposure %>% mutate(exposure1 = round(exposure,0),
                                exposure_q = ifelse(exposure1 == 1, 'Very Low',
                                                    ifelse(exposure1 == 2, 'Low',
                                                           ifelse(exposure1 == 3, 'Moderate',
                                                                  ifelse(exposure1 == 4, 'High', 'Very high')))))
## Exposure plot and tables

th_ex_plot <- exposure %>% ggplot(aes(x = reorder(threat, -exposure), y = exposure)) +
  geom_boxplot()
bio_ex_plot <- exposure %>% ggplot(aes(x = reorder(bioregion, -exposure), y = exposure)) +
  geom_boxplot()

bio_exp <- exposure %>% 
  filter(!is.na(exposure)) %>% 
  group_by(bioregion) %>% 
  summarise(mean = round(mean(exposure),2),
            SE = round(stderr(exposure),2))

bio_exp <- bio_exp %>% mutate(exposure = round(mean,0),
                              exposure_q = ifelse(exposure == 1, 'Very Low',
                                                  ifelse(exposure == 2, 'Low',
                                                         ifelse(exposure == 3, 'Moderate',
                                                                ifelse(exposure == 4, 'High', 'Very high')))))
th_exp <- exposure %>% 
  filter(!is.na(exposure)) %>% 
  group_by(threat) %>% 
  summarise(mean = round(mean(exposure),2),
            SE = round(stderr(exposure),2))
th_exp <- th_exp %>% mutate(exposure = round(mean,0),
                            exposure_q = ifelse(exposure == 1, 'Very Low',
                                                ifelse(exposure == 2, 'Low',
                                                       ifelse(exposure == 3, 'Moderate',
                                                              ifelse(exposure == 4, 'High', 'Very high')))))
exp_3 <- exposure %>% arrange(desc(exposure)) %>% head(3)
exp_3_b1 <- exposure %>% filter(bioregion == 'b1') %>% arrange(desc(exposure)) %>% head(3)
exp_3_b2 <- exposure %>% filter(bioregion == 'b2') %>% arrange(desc(exposure)) %>% head(3)
exp_3_b3 <- exposure %>% filter(bioregion == 'b3') %>% arrange(desc(exposure)) %>% head(3)
exp_3_b4 <- exposure %>% filter(bioregion == 'b4') %>% arrange(desc(exposure)) %>% head(3)
exp_3_b5 <- exposure %>% filter(bioregion == 'b5') %>% arrange(desc(exposure)) %>% head(3)
exp_3_b6 <- exposure %>% filter(bioregion == 'b6') %>% arrange(desc(exposure)) %>% head(3)






# Calculate weighted scores for Sensitivity

## Functional Impact

fi <- scientist %>% select(matches('^fi_.{2,}_b[1-6]')) %>% select(-contains('other'))
# Make NA values as 0
fi[is.na(fi)] <- 0
col_fi <-seq(1,ncol(fi),by=2)
weighted_fi <- mapply(weighted.mean,fi[,col_fi],fi[,-col_fi],MoreArgs=list(paired=TRUE))
fi_df <- data.frame(as.list(weighted_fi))


## Resistance

res <- scientist %>% select(matches('^res_.{2,}_b[1-6]')) %>% select(-contains('other'))
# Make NA values as 0
res[is.na(res)] <- 0
col_res <-seq(1,ncol(res),by=2)
weighted_res <- mapply(weighted.mean,res[,col_res],res[,-col_res],MoreArgs=list(paired=TRUE))
res_df <- data.frame(as.list(weighted_res))

## Recover
rec <- scientist %>% select(matches('^rec_.{2,}_b[1-6]')) %>% select(-contains('other'))
# Make NA values as 0
rec[is.na(rec)] <- 0
col_rec <-seq(1,ncol(rec),by=2)
weighted_rec <- mapply(weighted.mean,rec[,col_rec],rec[,-col_rec],MoreArgs=list(paired=TRUE))
rec_df <- data.frame(as.list(weighted_rec))

## Sensitivity dataset
colnames(fi_df) <- sub("fi_", "", colnames(fi_df))
colnames(res_df) <- sub("res_", "", colnames(res_df))
colnames(rec_df) <- sub("rec_", "", colnames(rec_df))

sens_df <- bind_rows(fi_df, res_df, rec_df)
index1 <- c('fi','res','rec')
sens_df$index <- index1
sens_df_long <- sens_df %>% pivot_longer(sst_b1:drg_b6, names_to = c('threat','bioregion'),
                                         names_pattern = '(.*)_(b[1-6])', values_to = 'value')

sens_df_long <- sens_df_long %>% mutate(index = as.factor(index),
                                        threat = as.factor(threat),
                                        bioregion = as.factor(bioregion))
sensitivity <- sens_df_long %>% group_by(threat, bioregion) %>% summarise(sensitivity = mean(value))
sensitivity <- sensitivity %>%  mutate(sensitivity1 = round(sensitivity,0),
                                       sensitivity_q = ifelse(sensitivity1 == 1, 'Very Low',
                                                              ifelse(sensitivity1 == 2, 'Low',
                                                                     ifelse(sensitivity1 == 3, 'Moderate',
                                                                            ifelse(sensitivity1 == 4, 'High', 'Very high')))))


## Sensitivity plot and tables
sen_th_plot <- sensitivity %>% 
  filter(!is.na(sensitivity)) %>%  ggplot(aes(x = reorder(threat, -sensitivity), y = sensitivity)) +
  geom_boxplot()
sen_bio_plot <- sensitivity %>% ggplot(aes(x = reorder(bioregion, -sensitivity), y = sensitivity)) +
  geom_boxplot()

bio_sens <- sensitivity %>% 
  filter(!is.na(sensitivity)) %>% 
  group_by(bioregion) %>% 
  summarise(mean = round(mean(sensitivity),2),
            SE = round(stderr(sensitivity),2))

bio_sens <- bio_sens %>% mutate(sensitivity = round(mean,0),
                                sensitivity_q = ifelse(sensitivity == 1, 'Very Low',
                                                       ifelse(sensitivity == 2, 'Low',
                                                              ifelse(sensitivity == 3, 'Moderate',
                                                                     ifelse(sensitivity == 4, 'High', 'Very high')))))
th_sens <- sensitivity %>% 
  filter(!is.na(sensitivity)) %>% 
  group_by(threat) %>% 
  summarise(mean = round(mean(sensitivity),2),
            SE = round(stderr(sensitivity),2))
th_sens <- th_sens %>% mutate(sensitivity = round(mean,0),
                              sensitivity_q = ifelse(sensitivity == 1, 'Very Low',
                                                     ifelse(sensitivity == 2, 'Low',
                                                            ifelse(sensitivity == 3, 'Moderate',
                                                                   ifelse(sensitivity == 4, 'High', 'Very high')))))
sens_3 <- sensitivity %>% arrange(desc(sensitivity)) %>% head(3)
sens_3_b1 <- sensitivity %>% filter(bioregion == 'b1') %>% arrange(desc(sensitivity)) %>% head(3)
sens_3_b2 <- sensitivity %>% filter(bioregion == 'b2') %>% arrange(desc(sensitivity)) %>% head(3)
sens_3_b3 <- sensitivity %>% filter(bioregion == 'b3') %>% arrange(desc(sensitivity)) %>% head(3)
sens_3_b4 <- sensitivity %>% filter(bioregion == 'b4') %>% arrange(desc(sensitivity)) %>% head(3)
sens_3_b5 <- sensitivity %>% filter(bioregion == 'b5') %>% arrange(desc(sensitivity)) %>% head(3)
sens_3_b6 <- sensitivity %>% filter(bioregion == 'b6') %>% arrange(desc(sensitivity)) %>% head(3)



## Potential Impacts
pi_df <- left_join(exposure,sensitivity)
pi_df <- pi_df %>% mutate(potential_impact = exposure*sensitivity,
                          pi = ifelse(potential_impact >= 20, 'Extreme', 
                                      ifelse(potential_impact > 10 & potential_impact < 20, 'High',
                                             ifelse(potential_impact > 5 & potential_impact <= 10, 'Moderate', 'Low'))))

# Plot Potential Impacts

pi_df %>% filter(!is.na(pi)) %>% ggplot(aes(x = reorder(bioregion, -potential_impact), y = potential_impact)) + geom_boxplot()

pi_df %>% filter(!is.na(pi)) %>% ggplot(aes(x = reorder(threat, -potential_impact), y = potential_impact)) + geom_boxplot()

bio_pi <- pi_df %>% 
  filter(!is.na(pi)) %>% 
  group_by(bioregion) %>% 
  summarise(mean = round(mean(potential_impact),2),
            SE = round(stderr(potential_impact),2))
th_pi <- pi_df %>% 
  filter(!is.na(pi)) %>% 
  group_by(threat) %>% 
  summarise(mean = round(mean(potential_impact),2),
            SE = round(stderr(potential_impact),2))

bio_pi <- bio_pi %>% mutate(potential_impact_q = ifelse(mean >= 20, 'Extreme',
                                                        ifelse(mean < 20 & mean > 11, 'High',
                                                               ifelse(mean > 5 & mean < 11, 'Moderate', 'Low'))))
th_pi <- th_pi %>% mutate(potential_impact_q = ifelse(mean >= 20, 'Extreme',
                                                      ifelse(mean < 20 & mean > 11, 'High',
                                                             ifelse(mean > 5 & mean < 11, 'Moderate', 'Low'))))
tot_pi <- pi_df%>% arrange(desc(potential_impact)) %>% head(3)

pi_3_b1 <- pi_df %>% filter(bioregion == 'b1') %>% arrange(desc(potential_impact)) %>% head(3)
pi_3_b2 <- pi_df %>% filter(bioregion == 'b2') %>% arrange(desc(potential_impact)) %>% head(3)
pi_3_b3 <- pi_df %>% filter(bioregion == 'b3') %>% arrange(desc(potential_impact)) %>% head(3)
pi_3_b4 <- pi_df %>% filter(bioregion == 'b4') %>% arrange(desc(potential_impact)) %>% head(3)
pi_3_b5 <- pi_df %>% filter(bioregion == 'b5') %>% arrange(desc(potential_impact)) %>% head(3)
pi_3_b6 <- pi_df %>% filter(bioregion == 'b6') %>% arrange(desc(potential_impact)) %>% head(3)


# Create a Risk Matrix


nRow <- 5 #9
nCol <- 5 #16
CVImatrix <- matrix(c(1,2,3,4,5,2,4,6,8,10,3,6,9,12,15,4,8,12,16,20,5,10,15,20,25), nrow = 5, ncol = 5, byrow = TRUE)
CVIData <- CVImatrix #matrix(rnorm(nRow * nCol), ncol = nCol)
rownames(CVIData) <- c("1", "2", "3", "4","5")  #letters[1:nRow]
colnames(CVIData) <- c("1", "2", "3", "4","5")  #LETTERS[1:nCol]
# For melt() to work seamlessly, myData has to be a matrix.
# Tidy up the data for processing. The longData dataframe is used to set the colors for the heat map
longCVIData <- melt(CVIData)
colnames(longCVIData) <- c("exposure", "sensitivity", "potential_impact")
#longData <- longData %>% mutate('Potential impact' = as.numeric('Potential impact'))
# Create the Color Pallete
CVIPalette <- colorRampPalette(rev(brewer.pal(11, "RdYlGn")))

## Plotting the risk matrix
pi_plot1 <- ggplot(longCVIData, aes(x = exposure, y = sensitivity, fill = potential_impact)) + 
  geom_tile() + 
  scale_fill_gradientn(colours = CVIPalette(4), name = 'Potential impact', breaks = c(0,6,12,18,25), labels = c('No Impact','Low', 'Moderate','High','Extreme') ) +
  scale_x_continuous(breaks = 0:6, expand = c(0,0)) +
  scale_y_continuous(breaks = 0:6, expand = c(0,0)) +
  coord_fixed() +
  theme_bw() +
  facet_wrap(~bioregion) +
  annotate(geom = 'text', x = 1, y = c(1:5), label = 'L', color = 'white') +
  annotate(geom = 'text', x = c(2:5), y = 1, label = 'L', color = 'white') +
  annotate(geom = 'text', x = 2, y = c(3:5), label = 'M', color = 'white') +
  annotate(geom = 'text', x = 2, y = 2, label = 'L', color = 'white') +
  annotate(geom = 'text', x = c(3:5), y = 2, label = 'M', color = 'white') +
  annotate(geom = 'text', x = 3, y = 3, label = 'M', color = 'white') +
  annotate(geom = 'text', x = 3, y = c(4,5), label = 'H', color = 'white') +
  annotate(geom = 'text', x = c(4,5), y = 3, label = 'H', color = 'white') +
  annotate(geom = 'text', x = 4, y = 4, label = 'H', color = 'white') +
  annotate(geom = 'text', x = c(4,5), y = 5, label = 'E', color = 'white') +
  annotate(geom = 'text', x = 5, y = 4, label = 'E', color = 'white') +
  geom_point(data = pi_df, aes(x = exposure, y = sensitivity), position = 'jitter') +
  geom_label_repel(data = pi_df, aes(label = threat))

pi_plot2 <- ggplot(longCVIData, aes(x = exposure, y = sensitivity, fill = potential_impact)) + 
  geom_tile() + 
  scale_fill_gradientn(colours = CVIPalette(4), name = 'Potential impact', breaks = c(0,6,12,18,25), labels = c('No Impact','Low', 'Moderate','High','Extreme')) +
  scale_x_continuous(breaks = 0:6, expand = c(0,0)) +
  scale_y_continuous(breaks = 0:6, expand = c(0,0)) +
  coord_fixed() +
  theme_bw() +
  annotate(geom = 'text', x = 1, y = c(1:5), label = 'L', color = 'white') +
  annotate(geom = 'text', x = c(2:5), y = 1, label = 'L', color = 'white') +
  annotate(geom = 'text', x = 2, y = c(3:5), label = 'M', color = 'white') +
  annotate(geom = 'text', x = 2, y = 2, label = 'L', color = 'white') +
  annotate(geom = 'text', x = c(3:5), y = 2, label = 'M', color = 'white') +
  annotate(geom = 'text', x = 3, y = 3, label = 'M', color = 'white') +
  annotate(geom = 'text', x = 3, y = c(4,5), label = 'H', color = 'white') +
  annotate(geom = 'text', x = c(4,5), y = 3, label = 'H', color = 'white') +
  annotate(geom = 'text', x = 4, y = 4, label = 'H', color = 'white') +
  annotate(geom = 'text', x = c(4,5), y = 5, label = 'E', color = 'white') +
  annotate(geom = 'text', x = 5, y = 4, label = 'E', color = 'white') +
  geom_point(data = pi_df, aes(x = exposure, y = sensitivity), position = 'jitter') +
  facet_wrap(~threat)

## Cumulative
cumulative <- scientist %>% 
  select(ht_.ht:ao_hy_cer) %>% 
  mutate(across(matches('.*_cer$'), ~ as.numeric(as.character(.x))))
colnames(cumulative) <- sub('_\\.','_', colnames(cumulative))

cumulative_long <- cumulative %>% select(-matches('_cer$')) %>% pivot_longer(everything(), names_to = 'com_th', values_to = 'cum_imp')
cumulative_cert <- cumulative %>% select(matches('_cer$'))
colnames(cumulative_cert) <- sub("_cer","", colnames(cumulative_cert))

certainty_long <-cumulative_cert %>% 
  pivot_longer(everything(), 
               names_to = 'com_th', values_to = 'cert')
cumulative_long_cer <- left_join(cumulative_long,certainty_long)
cumulative_long_cer <- cumulative_long_cer %>% 
  filter(!is.na(cum_imp) & !is.na(cert)) %>% 
  mutate(com_th = as.factor(com_th),
         cum_imp = as.factor(cum_imp))
summary_cum <- cumulative_long_cer %>%
  group_by(com_th, cum_imp) %>% 
  summarise(weighted_count = n())

cumulative_plot <- summary_cum %>% ggplot(aes(x = com_th, y = weighted_count, fill = cum_imp)) + geom_bar(stat = 'identity', position = position_dodge()) +
  scale_y_continuous(name = 'Weighted counts') +
  scale_fill_discrete(name = 'Cumulative impact') +
  scale_x_discrete(name = 'Threats combination') + theme_pubr()





