#Libraries

library(car)       #for regression diagnostics
library(broom)     #for tidy output
library(ggfortify) #for model diagnostics
library(sjPlot)    #for outputs
library(knitr)     #for kable
library(effects)   #for partial effects plots
library(emmeans)   #for estimating marginal means
library(ggeffects) #for plotting marginal means
library(MASS)      #for glm.nb
library(MuMIn)     #for AICc
library(tidyverse) #for data wrangling
library(modelr)    #for auxillary modelling functions
library(DHARMa)    #for residual diagnostics plots
library(performance) #for residuals diagnostics
library(see)         #for plotting residuals
library(patchwork) #grid of plots
library(scales)    #for more scales



# Create the dataset
exp_SE <- exposure %>% 
    ungroup() %>% 
    select(SE, type) 
  
exp_SE <- exp_SE %>%  mutate(index = rep('exp', nrow(exp_SE)))

sens_SE <- sensitivity %>% 
  ungroup() %>% 
  select(SE, type)  
  
sens_SE <- sens_SE %>%mutate(index = rep('sens', nrow(sens_SE)))

linear_df <- rbind(exp_SE,sens_SE)

# Categorical variables as factors

linear_df <- linear_df %>% mutate(type = as.factor(type),
                     index = as.factor(index)) %>% glimpse()
# Fit the model
exp_sens_lm0 <- glm(SE ~ 1, data = linear_df, family = gaussian(link = 'identity'))
exp_sens_lm <- glm(SE ~ index*type, data = linear_df, family = gaussian(link = 'identity'))
exp_sens_lm1 <- glm(SE ~ index + type, data = linear_df, family = gaussian(link = 'identity'))
exp_sens_lm2 <- glm(SE ~ index, data = linear_df, family = gaussian(link = 'identity'))
exp_sens_lm3 <- glm(SE ~ type, data = linear_df, family = gaussian(link = 'identity'))

Anova(exp_sens_lm)
Anova(exp_sens_lm1)

AICc(exp_sens_lm0,exp_sens_lm1,exp_sens_lm2,exp_sens_lm3)

#Diagnostic
autoplot(exp_sens_lm)
exp.resid <-simulateResiduals(exp_sens_lm, plot = TRUE)
# Checking for overdispersion
testDispersion(exp.resid)
testZeroInflation(exp.resid)
##
autoplot(exp_sens_lm1)
exp.resid1 <-simulateResiduals(exp_sens_lm1, plot = TRUE)
# Checking for overdispersion
testDispersion(exp.resid1)
testZeroInflation(exp.resid1)

# Summary
plot_model(exp_sens_lm, type = 'eff', terms = c('index', 'type'))
summary(exp_sens_lm)
##
plot_model(exp_sens_lm1, type = 'eff', terms = c('index', 'type'))
summary(exp_sens_lm1)

# Absolute changes
exp_sens_lm %>% emmeans(~index|type) %>% regrid() %>% pairs() %>% confint
exp_sens_lm %>% emmeans(~type|index) %>% regrid() %>% pairs() %>% confint

exp_sens_lm1 %>% emmeans(~index|type) %>% regrid() %>% pairs() %>% confint
exp_sens_lm1 %>% emmeans(~type|index) %>% regrid() %>% pairs() %>% confint



#Predicitons
exp_sens.grid <- with(linear_df, list(type=levels(type), 
                               SE=seq_range(SE, n=100)))
newdata_exp_sens <-  emmeans(exp_sens_lm, ~index|type, type = 'response') %>%
    as.data.frame

lm_plot <- ggplot(newdata_exp_sens, aes(y = emmean, x = index)) + 
  geom_pointrange(aes(ymin=lower.CL, ymax=upper.CL, shape = type), 
                  position = position_dodge(width = 0.2)) + 
  scale_shape_manual(labels = c('climate_change' = 'Climate change', 'human' = 'Direct-anthropogenic'),
                     name = 'Stressor category', values=c(21,22)) +
  theme_classic() +
  theme(axis.title = element_blank(),
        legend.position = c(0.01,1), 
        legend.justification = c(0,1)) +
  scale_x_discrete(labels = c('exp' = 'Exposure',
                              'sens' = 'Sensitivity')) 
 



exp_sens.grid1 <- with(linear_df, list(type=levels(type), 
                                      SE=seq_range(SE, n=100)))
newdata_exp_sens1 <-  emmeans(exp_sens_lm1, ~index|type, type = 'response') %>%
  as.data.frame

lm_plot1 <- ggplot(newdata_exp_sens1, aes(y = emmean, x = index)) + 
  geom_pointrange(aes(ymin=lower.CL, ymax=upper.CL, shape = type), 
                  position = position_dodge(width = 0.2)) + 
  scale_shape_manual(labels = c('climate_change' = 'Climate change', 'human' = 'Direct-anthropogenic'),
                     name = 'Stressor category', values=c(21,22)) +
  theme_classic() +
  theme(axis.title = element_blank(),
        legend.position = c(0.01,1), legend.justification = c(0,1)) +
  scale_x_discrete(labels = c('exp' = 'Exposure',
                              'sens' = 'Sensitivity')) 
