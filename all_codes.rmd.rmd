---
title: "World Heritage seagrass habitats CVI results"
author: "Riccardo Losciale"
date: "27/10/2021"
output: 
  html_document:
    toc: true
    toc_float: true
    number_section: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r Libraries, include=FALSE}
library('car')
library('dendextend')
library("patchwork")
library('stargazer')
library('VGAM')
library('ggsci')
library('binom')
library("ggpubr")
library("forcats")
library("gplots")
library("latticeExtra")
library("grid")
library("vcd")
library("corrplot")
library("stats")
library("ggrepel")
#library("brms")
library("extrafont")
library("hrbrthemes")
#library("statmod")
library('wordcloud2')
#library('ggfortify')
library('DHARMa') # Package for residuals diagnostic of almost all tipes of models
library('sjPlot') # Make summary tables (statistics, models etc) link: https://strengejacke.github.io/sjPlot/
library('emmeans') # Make marginal plot of models with predictions and errors 
library('ggeffects')
#library('broom.mixed')
#library('effects')
library('knitr')
library('MASS')
library('MuMIn')
library('ggsci')
#library('glmmTMB')
library('stargazer')
#library('ResourceSelection')
#library('splitstackshape')
library('mclogit')
library('broom') #tidy() function
library('RColorBrewer')
library('reshape2')
library('multcomp')
library('gridExtra')
library("tidyverse")
```


```{r Functions, include=FALSE}
stderr <- function(x, na.rm=FALSE){
  if (na.rm) x <- na.omit(x)
  sqrt(var(x)/length(x))
}

rescale_6_to_5 <- function(x) {
  y = (x/6)*5
return(y)}

rescale_3_to_5 <- function(x) {
  y = (x/3)*5
return(y)}

```

```{r Open file, include=FALSE}
scientist <- read.csv('../Data/experts.csv')
managers <- read.csv('../Data/managers.csv')
```



```{r data manipulation, message=FALSE, warning=FALSE, include=FALSE, paged.print=FALSE}
# Change all character and logical vectors to factors
scientist[sapply(scientist, is.character)] <- lapply(scientist[sapply(scientist, is.character)], 
as.factor)
scientist[sapply(scientist, is.logical)] <- lapply(scientist[sapply(scientist, is.logical)], 
as.factor)

### Regular expressions
#Spatial scale: "^sp_.{2,}_b[1-6]$"
#Frequency: "^fr_.{2,}_b[1-6]$"
#Trend: "^tr_.{2,}_b[1-6]$"
#Functional Impact: "^fi_.{2,}_b[1-6]$"
#Resistance: "^res_.{2,}_b[1-6]$"
#Recovery : "^rec_.{2,}_b[1-6]$"
#Certainty: ".*_cer$"

### Current scale
#Spatial scale to 1 to 6 
#Frequency 1 to 5
#Trend 1 to 3

#Functional impact 1 to 5
#Resistance 1 to 3
#Recovery 1 to 5
#Certainty 1 to 4

## Recode factors

scientist <- scientist %>% mutate(across(.cols = matches("^sp_.{2,}_b[1-6]$"),
                            ~ recode_factor(.x, 'X < 1 km^2' = '1',
                                            '1 ? X < 10 km^2' = '2',
                                            '10 ? X < 100 km^2' = '3', 
                                            '100 ? X < 1,000 km ^2' = '4',
                                            '1,000 ? X < 10,000 km^2' = '5',
                                            'X ? 10,000 km^2' = '6'))) %>% 
  mutate(across(.cols = matches("^fr_.{2,}_b[1-6]$"), 
                ~ recode_factor(.x, 
                                'Never occurs' = '1', 
                                'Intermittent' = '2', 
                                'Occasional' = '3', 
                                'Frequent' = '4', 
                                'Ongoing' = '5' ))) %>% 
  mutate(across(.cols = matches("^tr_.{2,}_b[1-6]$"),
                ~ recode_factor(.x, 'Decreasing' = '1', 
                                'Stable' = '2',
                                'Increasing' = '3'))) %>% 
  mutate(across(.cols = matches("^fi_.{2,}_b[1-6]$"), 
                            ~ recode_factor(.x, "No Impact" = '1', 
                                            'Spp. at geographic limit' = '2', 
                                            '? 25% of species' = '3',
                                            '25 < X ? 50% of species' = '4', 
                                            '50 < X ? 100% of species' = '5'))) %>% 
  mutate(across(.cols = matches("^res_.{2,}_b[1-6]$"), 
                            ~ recode_factor(.x, "Low resistance" = '3', 
                                            'Medium resistance' = '2', 
                                            'High resistance' = '1'))) %>% 
  mutate(across(.cols = matches("^rec_.{2,}_b[1-6]$"), 
                            ~ recode_factor(.x, "No Impact" = '1', 
                                            'X ? 1 year' = '2', 
                                            '1 < X ? 10 years' = '3',
                                            '10 < X ? 100 years' = '4', 
                                            'X > 100 years' = '5'))) %>% 
  mutate(across(.cols = matches('.*_cer$'),
                ~ recode_factor(.x, 'Low' = '1', 
                                'Medium' = '2',
                                'High' = '3',
                                'Very High' = '4')))
## Reconvert them to numbers
scientist <- scientist %>% mutate(across(.cols = sp_sst_b1:rec_others_b52, ~ as.numeric(as.character(.x))))

## Rescale sp, fr, tr, fi, res , rec (1-5)
scientist <- scientist %>% mutate(across(matches('^sp_.{2,}_b[1-6]$'), 
                            ~ rescale_6_to_5(.x))) %>%
  mutate(across(matches('^(tr|res)_.{2,}_b[1-6]$'), 
                            ~ rescale_3_to_5(.x)))

# Managers
managers[sapply(managers, is.character)] <- lapply(managers[sapply(managers, is.character)], 
as.factor)
managers[sapply(managers, is.logical)] <- lapply(managers[sapply(managers, is.logical)], 
as.factor)

managers <- managers %>% mutate(across(.cols = matches("^sp_.{2,}$"),
                            ~ recode_factor(.x, 'Not present' = '1',
                                            'Restricted (? 10%)' = '2',
                                            'Localized (11 - 50 %)' = '3', 
                                            'Extensive (51 - 90%)' = '4',
                                            'Very widespread (91 - 100%)' = '5'))) %>% 
  mutate(across(.cols = matches("^fr_.{2,}$"), 
                ~ recode_factor(.x, 
                                'Never occurs' = '1', 
                                'Intermittent' = '2', 
                                'Occasional' = '3', 
                                'Frequent' = '4', 
                                'Ongoing' = '5' ))) %>% 
  mutate(across(.cols = matches("^tr_.{2,}$"),
                ~ recode_factor(.x, 'Decreasing' = '1', 
                                'Stable' = '2',
                                'Increasing' = '3')))

#OUV dependency
managers <- managers %>% mutate(OUV = ifelse(ouv_5 == 1, 5, 
                                 ifelse(ouv_4 == 1 & ouv_5 != 1, 4, 
                                        ifelse(ouv_3 == 1 & ouv_4 != 1 & ouv_5 != 1, 3,
                                               ifelse(ouv_2 == 1 & ouv_3 != 1 & ouv_4 != 1 & ouv_5 != 1, 2, 
                                                    ifelse(ouv_1 == 1 & ouv_2 != 1 & ouv_3 != 1 & ouv_4 != 1 & ouv_5 != 1, 
                                                           1, NA))))))
# Community dependency
managers <- managers %>% mutate(COM = com_food + com_eco + com_social + com_cultural,
                    COM = ifelse(COM == 0 & com_no_imp == 0, NA, COM))
# Adaptive capacity
managers <- managers %>% mutate(ad_res = recode_factor(ad_res, 'None' = 1, 'Low Resources' = 2,
                                           'Moderate Resources' = 3, 'High Resources' = 4),
                    ad_sci = recode_factor(ad_sci,'None' = 1,
                                           'Low Support' = 2,
                                           'Moderate Support' = 3,
                                           'High Support' = 4),
                    ad_cc = recode_factor(ad_cc, 'Very Low/None' = 1,
                                          'Low' = 2,
                                          'Moderate' = 3,
                                          'High' = 4)) 
managers <- managers %>% mutate(certainty = ifelse(info_se == 1, 4, 
                                 ifelse(info_ce == 1 & info_se != 1, 3, 
                                        ifelse(info_cm == 1 & info_se != 1 & info_ce != 1, 2,
                                               ifelse(info_pe == 1 & info_cm != 1 & info_ce != 1 & info_se != 1, 1,0))))) 

managers_cleaned <- managers %>% select(- c(ouv_0:info_se)) 

managers_cleaned <- managers_cleaned %>% mutate(across(.cols = sp_ar:certainty, ~ as.numeric(as.character(.x))))

managers_cleaned <- managers_cleaned %>% mutate(across(matches('^tr_'), 
                            ~ rescale_3_to_5(.x)))
managers_summary <- managers_cleaned %>% group_by(wh) %>% summarise(across(.cols = sp_ar:certainty,.fns = ~ mean(.x, na.rm = TRUE)))
managers_summary_long <- managers_summary %>% pivot_longer(sp_ar:tr_ao, names_to = c('index','threat'),
                                   names_pattern = '(.*)_(.*)', values_to = 'value') %>% 
  mutate(threat = as.factor(threat))


```

# Seagrass scientists response analysis
## Exposure and Sensitivity plots and tables

```{r Calculation, echo=FALSE, message=FALSE, warning=FALSE}
# Calculate weighted scores for Exposure
# Spatial scale
sp <- scientist %>% select(matches('^sp_.{2,}_b[1-6]')) %>% select(-contains('other'))

# Make NA values as 0
sp[is.na(sp)] <- 0
col_sp <-seq(1,ncol(sp),by=2)
weighted_sp <- mapply(weighted.mean,sp[,col_sp],sp[,-col_sp],MoreArgs=list(paired=TRUE))
sp_df <- data.frame(as.list(weighted_sp))
sp_df <- sp_df %>% rename(sp_tra_b5 = sp_tr_b5, sp_tra_b6 = sp_tr_b6)

## Frequency

fr <- scientist %>% select(matches('^fr_.{2,}_b[1-6]')) %>% select(-contains('other'))
# Make NA values as 0
fr[is.na(fr)] <- 0
col_fr <-seq(1,ncol(fr),by=2)
weighted_fr <- mapply(weighted.mean,fr[,col_fr],fr[,-col_fr],MoreArgs=list(paired=TRUE))
fr_df <- data.frame(as.list(weighted_fr))
fr_df <- fr_df %>% rename(fr_tra_b5 = fr_tr_b5, fr_tra_b6 = fr_tr_b6)

## Trend

tre <- scientist %>% select(matches('^tr_.{2,}_b[1-6]')) %>% select(-contains('other'))
# Make NA values as 0
tre[is.na(tre)] <- 0
col_tre <-seq(1,ncol(tre),by=2)
weighted_tre <- mapply(weighted.mean,tre[,col_tre],tre[,-col_tre],MoreArgs=list(paired=TRUE))
tre_df <- data.frame(as.list(weighted_tre))

## Exposure dataset

colnames(sp_df) <- sub("sp_", "", colnames(sp_df))
colnames(fr_df) <- sub("fr_", "", colnames(fr_df))
colnames(tre_df) <- sub("tr_", "", colnames(tre_df))



ex_df <- bind_rows(sp_df, fr_df, tre_df)
index <- c('sp','fr','tr')
ex_df$index <- index
ex_df <- ex_df %>% mutate(index = as.factor(index))
ex_df_long <- ex_df %>% pivot_longer(sst_b1:drg_b6, names_to = c('threat','bioregion'),
                                     names_pattern = '(.*)_(b[1-6])', values_to = 'value')

ex_df_long <- ex_df_long %>% mutate(threat = as.factor(threat),
                      bioregion = as.factor(bioregion))
exposure <- ex_df_long %>% group_by(threat, bioregion) %>% summarise(exposure = mean(value),
                                                                     sd = sd(value),
                                                                     SE = stderr(value),
                                                                     cv = (sd(value)/mean(value)*100))
exposure <- exposure %>% mutate(exposure1 = round(exposure,0),
                    exposure_q = ifelse(exposure1 == 1, 'Very Low',
                                        ifelse(exposure1 == 2, 'Low',
                                               ifelse(exposure1 == 3, 'Moderate',
                                                      ifelse(exposure1 == 4, 'High', 'Very high')))))
exposure <- exposure %>% 
  mutate(type = ifelse(threat == 'mh'|threat == 'storm'|threat == 'dr'|threat == 'slr'|threat == 'sst'|threat == 'rain'|threat == 'ao','climate_change','human' ))

## Boxplot of Exposure values of climate change and anthropogenic threats per bioregions

bio_ex_plot <- exposure %>% 
  mutate(bioregion = fct_reorder(bioregion, exposure, .fun = 'mean')) %>% 
  filter(!is.na(exposure))  %>% 
    ggplot(aes(x = reorder(bioregion, -exposure), y = exposure, color = type)) +
    geom_boxplot() + 
    theme_pubr() +
    ylab("Exposure") +
    theme(axis.title.x = element_blank(),
          axis.title.y = element_text(face = 'bold', size = 12),
          axis.text = element_text(size = 12),
          legend.title = element_blank(),
          legend.text = element_blank(),
          legend.position = 'none') +
  scale_x_discrete(labels = c('1','3','4','6','5','2')) + 
  scale_y_continuous(breaks = c(1,2,3,4,5), limits = c(0,5))



## Boxplot of Exposure values for each threat globally 

th_ex_plot <- exposure %>% 
     mutate(bioregion = fct_reorder(threat, exposure, .fun = 'median')) %>% 
     filter(!is.na(exposure))  %>% 
     ggplot(aes(x = reorder(threat, -exposure), y = exposure, color = type)) +
     geom_boxplot() + 
     theme_pubr() +
     theme(axis.title.x = element_blank(),
           axis.title.y = element_blank(),
           axis.text = element_text(size = 12),
           axis.text.x = element_text(angle = 90, vjust = 0.2, hjust = 0.95),
           legend.title = element_blank(),
           legend.text = element_text(size = 14, face = 'bold'))+
     scale_x_discrete(labels = c('SST', 'AO','SLR','CD','R','OF','MH','DR','AR','S','U/IR','SRBA','DRG','TRA','AQI','SWQ','SRBP', 'LCBP', 'LCBA')) +
  scale_y_continuous(breaks = c(1,2,3,4,5), limits = c(0,5)) +
  scale_color_discrete(labels = c('Climate change','Direct-anthropogenic')) + 
  theme(legend.position = c(0.85,0.95))


# Mean, SE and categorical values of exposure per bioregions
bio_exp <- exposure %>% 
  filter(!is.na(exposure)) %>% 
  group_by(bioregion) %>% 
  summarise(mean = round(mean(exposure),2),
            SE = round(stderr(exposure),2),
            median = round(median(exposure),2)) %>% 
  mutate(exposure = round(mean,0),
            exposure_q = ifelse(exposure == 1, 'Very Low',
                                ifelse(exposure == 2, 'Low',
                                       ifelse(exposure == 3, 'Moderate',
                                              ifelse(exposure == 4, 'High', 'Very high'))))) 

# Mean, SE and categorical values of exposure per threat
th_exp <- exposure %>% 
  filter(!is.na(exposure)) %>% 
  group_by(threat) %>% 
  summarise(mean = round(mean(exposure),2),
            SE = round(stderr(exposure),2),
            median = round(median(exposure),2)) %>% 
  mutate(exposure = round(mean,0),
            exposure_q = ifelse(exposure == 1, 'Very Low',
                                ifelse(exposure == 2, 'Low',
                                       ifelse(exposure == 3, 'Moderate',
                                              ifelse(exposure == 4, 'High', 'Very high'))))) %>% 
  mutate(type = ifelse(threat == 'mh'|threat == 'storm'|threat == 'dr'|threat == 'slr'|threat == 'sst'|threat == 'rain'|threat == 'ao','climate_change','human' ))


# Top 3 Threats by exposure (Overall and per bioregion)
exp_3 <- exposure %>% arrange(desc(exposure)) %>% head(3)
exp_3_b1 <- exposure %>% filter(bioregion == 'b1') %>% arrange(desc(exposure)) %>% head(3)
exp_3_b2 <- exposure %>% filter(bioregion == 'b2') %>% arrange(desc(exposure)) %>% head(3)
exp_3_b3 <- exposure %>% filter(bioregion == 'b3') %>% arrange(desc(exposure)) %>% head(3)
exp_3_b4 <- exposure %>% filter(bioregion == 'b4') %>% arrange(desc(exposure)) %>% head(3)
exp_3_b5 <- exposure %>% filter(bioregion == 'b5') %>% arrange(desc(exposure)) %>% head(3)
exp_3_b6 <- exposure %>% filter(bioregion == 'b6') %>% arrange(desc(exposure)) %>% head(3)

## Calculate weighted scores for Sensitivity

# Functional Impact
fi <- scientist %>% select(matches('^fi_.{2,}_b[1-6]')) %>% select(-contains('other'))
# Make NA values as 0
fi[is.na(fi)] <- 0
col_fi <-seq(1,ncol(fi),by=2)
weighted_fi <- mapply(weighted.mean,fi[,col_fi],fi[,-col_fi],MoreArgs=list(paired=TRUE))
fi_df <- data.frame(as.list(weighted_fi))

# Resistance

res <- scientist %>% select(matches('^res_.{2,}_b[1-6]')) %>% select(-contains('other'))
# Make NA values as 0
res[is.na(res)] <- 0
col_res <-seq(1,ncol(res),by=2)
weighted_res <- mapply(weighted.mean,res[,col_res],res[,-col_res],MoreArgs=list(paired=TRUE))
res_df <- data.frame(as.list(weighted_res))

## Recovery

rec <- scientist %>% select(matches('^rec_.{2,}_b[1-6]')) %>% select(-contains('other'))
# Make NA values as 0
rec[is.na(rec)] <- 0
col_rec <-seq(1,ncol(rec),by=2)
weighted_rec <- mapply(weighted.mean,rec[,col_rec],rec[,-col_rec],MoreArgs=list(paired=TRUE))
rec_df <- data.frame(as.list(weighted_rec))

## Sensitivity dataset

colnames(fi_df) <- sub("fi_", "", colnames(fi_df))
colnames(res_df) <- sub("res_", "", colnames(res_df))
colnames(rec_df) <- sub("rec_", "", colnames(rec_df))

sens_df <- bind_rows(fi_df, res_df, rec_df)
index1 <- c('fi','res','rec')
sens_df$index <- index1
sens_df_long <- sens_df %>% pivot_longer(sst_b1:drg_b6, names_to = c('threat','bioregion'),
                                     names_pattern = '(.*)_(b[1-6])', values_to = 'value')

sens_df_long <- sens_df_long %>% mutate(index = as.factor(index),
                      threat = as.factor(threat),
                      bioregion = as.factor(bioregion))
sensitivity <- sens_df_long %>% group_by(threat, bioregion) %>% summarise(sensitivity = mean(value),
                                                                     sd = sd(value),
                                                                     SE = stderr(value),
                                                                     cv = (sd(value)/mean(value)*100))
sensitivity <- sensitivity %>%  mutate(sensitivity1 = round(sensitivity,0),
                    sensitivity_q = ifelse(sensitivity1 == 1, 'Very Low',
                                        ifelse(sensitivity1 == 2, 'Low',
                                               ifelse(sensitivity1 == 3, 'Moderate',
                                                      ifelse(sensitivity1 == 4, 'High', 'Very high')))))

sensitivity <- sensitivity %>% 
  mutate(type = ifelse(threat == 'mh'|threat == 'storm'|threat == 'dr'|threat == 'slr'|threat == 'sst'|threat == 'rain'|threat == 'ao','climate_change','human' ))

## Boxplot of Sensitivity values of climate change and anthropogenic threats per bioregions (all the same)

bio_sens_plot <- sensitivity %>% 
  mutate(bioregion = fct_reorder(bioregion, sensitivity, .fun = 'mean')) %>% 
  filter(!is.na(sensitivity))  %>% 
    ggplot(aes(x = reorder(bioregion, -sensitivity), y = sensitivity, color = type)) +
    geom_boxplot() + 
    theme_pubr() +
    xlab('Bioregions (Short et al., 2007)') +
    ylab("Sensitivity") +
    labs(color = 'Threat') +
    theme(axis.title.x = element_text(face = 'bold', size = 12, margin = margin(t = 10)),
          axis.title.y = element_text(face = 'bold', size = 12),
          axis.text = element_text(size = 12),
          legend.position = 'none') +
  scale_x_discrete(labels = c('2','1','6','5','3','4')) + 
  scale_y_continuous(breaks = c(1,2,3,4,5), limits = c(0,5))


## Boxplot of Exposure values for each threat globally 

th_sens_plot <- sensitivity %>% 
     mutate(bioregion = fct_reorder(threat, sensitivity, .fun = 'median')) %>% 
     filter(!is.na(sensitivity))  %>% 
     ggplot(aes(x = reorder(threat, -sensitivity), y = sensitivity, color = type)) +
     geom_boxplot() + 
     theme_pubr() +
     xlab('Threats') +
     theme(axis.title.x = element_text(face = 'bold', size = 12, margin = margin(t = 10)),
           axis.text = element_text(size = 12),
           axis.text.x = element_text(angle = 90, vjust = 0.2, hjust = 0.95),
           legend.position = 'none',
           axis.title.y = element_blank()) +
     scale_x_discrete(labels = c('DRG', 'CD','TRA','AR','MH','U/IR','LCBA','SRBA','OF','AQI','S','SST','DR','LCBP','R','SRBP','SLR', 'AO', 'SWQ')) + 
  scale_y_continuous(breaks = c(1,2,3,4,5), limits = c(0,5))


# Mean, SE and categorical values of sensitivity per bioregions
bio_sens <- sensitivity %>% 
  filter(!is.na(sensitivity)) %>% 
  group_by(bioregion) %>% 
  summarise(mean = round(mean(sensitivity),2),
            SE = round(stderr(sensitivity),2),
            median = round(median(sensitivity),2)) %>% 
  mutate(sensitivity = round(mean,0),
            sensitivity_q = ifelse(sensitivity == 1, 'Very Low',
                                ifelse(sensitivity == 2, 'Low',
                                       ifelse(sensitivity == 3, 'Moderate',
                                              ifelse(sensitivity == 4, 'High', 'Very high')))))
            

# Mean, SE and categorical values of sensitivity per threat
th_sens <- sensitivity %>% 
  filter(!is.na(sensitivity)) %>% 
  group_by(threat) %>% 
  summarise(mean = round(mean(sensitivity),2),
            SE = round(stderr(sensitivity),2),
            median = round(median(sensitivity),2)) %>% 
  mutate(sensitivity = round(mean,0),
            sensitivity_q = ifelse(sensitivity == 1, 'Very Low',
                                ifelse(sensitivity == 2, 'Low',
                                       ifelse(sensitivity == 3, 'Moderate',
                                              ifelse(sensitivity == 4, 'High', 'Very high'))))) %>% 
  mutate(type = ifelse(threat == 'mh'|threat == 'storm'|threat == 'dr'|threat == 'slr'|threat == 'sst'|threat == 'rain'|threat == 'ao','climate_change','human' ))





# Top 3 Threats by sensitivity (Overall and per bioregion)

sens_3 <- sensitivity %>% arrange(desc(sensitivity)) %>% head(3)
sens_3_b1 <- sensitivity %>% filter(bioregion == 'b1') %>% arrange(desc(sensitivity)) %>% head(3)
sens_3_b2 <- sensitivity %>% filter(bioregion == 'b2') %>% arrange(desc(sensitivity)) %>% head(3)
sens_3_b3 <- sensitivity %>% filter(bioregion == 'b3') %>% arrange(desc(sensitivity)) %>% head(3)
sens_3_b4 <- sensitivity %>% filter(bioregion == 'b4') %>% arrange(desc(sensitivity)) %>% head(3)
sens_3_b5 <- sensitivity %>% filter(bioregion == 'b5') %>% arrange(desc(sensitivity)) %>% head(3)
sens_3_b6 <- sensitivity %>% filter(bioregion == 'b6') %>% arrange(desc(sensitivity)) %>% head(3)


```

Top Figure: Exposure scores across all threats to seagrass in each bioregion (Short et al., 2007).

Bottom Figure: Exposure scores across all bioregions for each threat.


```{r 1, echo=FALSE}
par(mar = c(4, 4, .1, .1))
bio_ex_plot 
th_ex_plot
```

Top Figure: Sensitivity scores across all threats to seagrass in each bioregion (Short et al., 2007).
Bottom Figure: Sensitivity scores across all bioregions for each threat.


```{r 2, echo=FALSE}
par(mar = c(4, 4, .1, .1))
bio_sens_plot
th_sens_plot

fig3 <- (bio_ex_plot + th_ex_plot) / (bio_sens_plot + th_sens_plot)
```

Table 1: Mean, SE and median **exposure** scores per *bioregion*

Table 2: Mean, SE and median **sensitivity** scores per *bioregion*

Table 3: Mean, SE and median **exposure** scores per *threat*

Table 4: Mean, SE and median **sensitivity** scores per *threat*

Table 5: Mean, SE and median **exposure** scores per *threat category* (climate change or anthropogenic)

Table 6: Mean, SE and median **sensitivity** scores per *threat category* (climate change or anthropogenic)

```{r 3, echo=FALSE}
bio_exp %>% arrange(-mean) %>%  kable()
bio_sens %>% arrange(-mean) %>% kable()
th_exp %>% arrange(-mean) %>% kable()
th_sens %>% arrange(-mean) %>% kable()
th_exp %>% group_by(type) %>% 
  summarise(mean = round(mean(mean),2),
            median = round(median(median),2),
            SE = round(mean(SE),2)) %>% 
  arrange(-mean)%>% 
  kable()

th_sens %>% 
  group_by(type) %>% 
  summarise(mean = round(mean(mean),2),
            median = round(median(median),2),
            SE = round(mean(SE),2)) %>% 
  arrange(-mean) %>% 
  kable()
```


## Potential Impact plots and tables

```{r potential_impact, echo=FALSE, message=FALSE, warning=FALSE}
## Potential Impacts dataset
pi_df <- merge(x = exposure, y = sensitivity, by = c('threat', 'bioregion', 'type'), all = TRUE) %>% select(c('threat','bioregion','type', 'exposure','cv.x', 'sensitivity','cv.y'))

pi_df1 <- pi_df %>% 
  mutate(potential_impact = exposure*sensitivity,
                 pi = ifelse(potential_impact >= 20, 'Extreme', 
                             ifelse(potential_impact >= 10 & potential_impact < 20, 'High',
                                    ifelse(potential_impact >= 5 & potential_impact < 10, 'Moderate', 'Low'))),
         type = factor(type)) %>% 
  group_by(bioregion) %>% 
  mutate(rank = rank(potential_impact, na.last = FALSE),
         rank2 = rank(-potential_impact, na.last = TRUE)) %>% ungroup()

pi_df_top3 <- pi_df %>% 
  mutate(potential_impact = exposure*sensitivity,
            pi = ifelse(potential_impact >= 20, 'Extreme', 
                        ifelse(potential_impact >= 10 & potential_impact < 20, 'High',
                               ifelse(potential_impact >= 5 & potential_impact < 10, 'Moderate', 'Low'))),
            type = factor(type)) %>% 
     group_by(type) %>% 
     mutate(rank = rank(potential_impact, na.last = FALSE)) %>% 
  ungroup() %>% 
  group_by(bioregion,type) %>% 
  slice_max(order_by = rank, n = 3) 
 


# Plot Potential Impacts
bio_pi_plot <- pi_df1 %>% 
     mutate(bioregion = fct_reorder(bioregion, potential_impact, .fun = 'median')) %>% 
     filter(!is.na(pi)) %>% 
     ggplot(aes(x = reorder(bioregion, -potential_impact), y = potential_impact, color = type)) + 
     geom_boxplot() +
     theme_pubr() +
     xlab('Bioregions (Short et al., 2007)') +
     ylab("Potential impact") +
     theme(axis.title.x = element_text(face = 'bold', size = 12, margin = margin(t = 10)),
           axis.title.y = element_text(face = 'bold', size = 12),
           axis.text = element_text(size = 12),
           axis.text.x = element_text(angle = 90, vjust = 0.2, hjust = 0.95),
           legend.title = element_blank(),
           legend.text = element_text(size = 12)) +
     scale_x_discrete(labels = c('Temperate Atlantic','Mediterranean',
                                 'Temperate Pacific','Temperate Southern Oceans',
                                 'Tropical Indo-Pacific','Tropical Atlantic')) +
     scale_color_discrete(labels = c('Climate change','Anthropogenic')) +
     scale_y_continuous(breaks = c(5,10,15,20), labels = c('Low', 'Moderate','High','Very high'), limits = c(0,20))

th_pi_plot <- pi_df1 %>% 
     mutate(bioregion = fct_reorder(bioregion, potential_impact, .fun = 'median')) %>% 
     filter(!is.na(pi)) %>% 
     ggplot(aes(x = reorder(threat, -potential_impact), y = potential_impact, color = type)) + 
     geom_boxplot() +
     theme_pubr() +
     xlab('Threats') +
     ylab("Potential impact") +
     theme(axis.title.x = element_text(face = 'bold', size = 12, margin = margin(t = 10)),
           axis.title.y = element_text(face = 'bold', size = 12),
           axis.text = element_text(size = 12),
           axis.text.x = element_text(angle = 90, vjust = 0.2, hjust = 0.95),
           legend.title = element_blank(),
           legend.text = element_text(size = 12)) +
     scale_color_discrete(labels = c('Climate change','Anthropogenic')) +
     scale_y_continuous(breaks = c(5,10,15,20), labels = c('Low', 'Moderate','High','Very high'), limits = c(0,20)) +
     scale_x_discrete(labels = c('CD','SST','AR','OF','MH','U/IR','DRG','DR','AO','TRA','S','R','SLR','SRBA','AQI','LCBA','SRBP','LCBP','SWQ'))

bio_pi <- pi_df1 %>% 
  filter(!is.na(pi)) %>% 
  group_by(bioregion) %>% 
  summarise(mean = round(mean(potential_impact),2),
            SE = round(stderr(potential_impact),2),
            median = round(median(potential_impact),2)) %>% 
  mutate(potential_impact_q = ifelse(mean >= 20, 'Extreme',
                                                      ifelse(mean < 20 & mean >= 10 , 'High',
                                                             ifelse(mean >= 5 & mean < 10, 'Moderate', 'Low'))),
         potential_impact_q_median = ifelse(median >= 20, 'Extreme',
                                                      ifelse(mean < 20 & mean >= 10 , 'High',
                                                             ifelse(mean >= 5 & mean < 10, 'Moderate', 'Low'))))



th_pi <- pi_df1 %>% 
  filter(!is.na(pi)) %>% 
  group_by(threat) %>% 
  summarise(mean = round(mean(potential_impact),2),
            SE = round(stderr(potential_impact),2),
            median = round(median(potential_impact),2)) %>% 
 mutate(potential_impact_q = ifelse(mean >= 20, 'Extreme',
                                                      ifelse(mean < 20 & mean >= 10 , 'High',
                                                             ifelse(mean >= 5 & mean < 10, 'Moderate', 'Low'))),
         potential_impact_q_median = ifelse(median >= 20, 'Extreme',
                                                      ifelse(mean < 20 & mean >= 10 , 'High',
                                                             ifelse(mean >= 5 & mean < 10, 'Moderate', 'Low')))) %>% 
  mutate(type = ifelse(threat == 'mh'|threat == 'storm'|threat == 'dr'|threat == 'slr'|threat == 'sst'|threat == 'rain'|threat == 'ao','climate_change','human' ))


tot_pi <- pi_df1%>% arrange(desc(potential_impact)) %>% head(3)

pi_cc_b1 <- pi_df1 %>% filter(bioregion == 'b1' & type == 'climate_change') %>% arrange(desc(potential_impact)) %>% head(3)
pi_cc_b2 <- pi_df1 %>% filter(bioregion == 'b2'& type == 'climate_change') %>% arrange(desc(potential_impact)) %>% head(3)
pi_cc_b3 <- pi_df1 %>% filter(bioregion == 'b3'& type == 'climate_change') %>% arrange(desc(potential_impact)) %>% head(3)
pi_cc_b4 <- pi_df1 %>% filter(bioregion == 'b4'& type == 'climate_change') %>% arrange(desc(potential_impact)) %>% head(3)
pi_cc_b5 <- pi_df1 %>% filter(bioregion == 'b5'& type == 'climate_change') %>% arrange(desc(potential_impact)) %>% head(3)
pi_cc_b6 <- pi_df1 %>% filter(bioregion == 'b6'& type == 'climate_change') %>% arrange(desc(potential_impact)) %>% head(3)

pi_cc_df <- rbind(pi_cc_b1,pi_cc_b2,pi_cc_b3,pi_cc_b4,pi_cc_b5,pi_cc_b6)

pi_h_b1 <- pi_df1 %>% filter(bioregion == 'b1' & type == 'human') %>% arrange(desc(potential_impact)) %>% head(3)
pi_h_b2 <- pi_df1 %>% filter(bioregion == 'b2'& type == 'human') %>% arrange(desc(potential_impact)) %>% head(3)
pi_h_b3 <- pi_df1 %>% filter(bioregion == 'b3'& type == 'human') %>% arrange(desc(potential_impact)) %>% head(3)
pi_h_b4 <- pi_df1 %>% filter(bioregion == 'b4'& type == 'human') %>% arrange(desc(potential_impact)) %>% head(3)
pi_h_b5 <- pi_df1 %>% filter(bioregion == 'b5'& type == 'human') %>% arrange(desc(potential_impact)) %>% head(3)
pi_h_b6 <- pi_df1 %>% filter(bioregion == 'b6'& type == 'human') %>% arrange(desc(potential_impact)) %>% head(3)

# Create a Risk Matrix
nRow <- 5 #9
nCol <- 5 #16
CVImatrix <- matrix(c(1,2,3,4,5,2,4,6,8,10,3,6,9,12,15,4,8,12,16,20,5,10,15,20,25), nrow = 5, ncol = 5, byrow = TRUE)
CVIData <- CVImatrix #matrix(rnorm(nRow * nCol), ncol = nCol)
rownames(CVIData) <- c("1", "2", "3", "4","5")  #letters[1:nRow]
colnames(CVIData) <- c("1", "2", "3", "4","5")  #LETTERS[1:nCol]
# For melt() to work seamlessly, myData has to be a matrix.
# Tidy up the data for processing. The longData dataframe is used to set the colors for the heat map
longCVIData <- melt(CVIData)
colnames(longCVIData) <- c("exposure", "sensitivity", "potential_impact")
#longData <- longData %>% mutate('Potential impact' = as.numeric('Potential impact'))
# Create the Color Pallete
CVIPalette <- colorRampPalette(rev(brewer.pal(11, "RdYlGn")))
## Plotting the risk matrix

## Make a labeller
bioregion_names <- list('b1' = 'Temperate Atlantic',
                        'b2' = 'Tropical Atlantic',
                        'b3' = 'Mediterranean',
                        'b4' = 'Temperate Pacific',
                        'b5'= 'Tropical Indo-Pacific',
                        'b6' = 'Temperate Southern Oceans')

bioregion_labeller <- function(variable,value){
  return(bioregion_names[value])
}


fig4 <- ggplot(longCVIData, aes(x = exposure, y = sensitivity, fill = potential_impact)) + 
     geom_tile() + 
     scale_fill_gradientn(colours = CVIPalette(4), name = 'Potential impact', breaks = c(0,5,10,15,20), limits = c(0,25), labels = c('No Impact','Low', 'Moderate','High','Extreme') ) +
     scale_x_continuous(breaks = 0:5, expand = c(0,0)) +
     scale_y_continuous(breaks = 0:5, expand = c(0,0)) +
     coord_fixed() +
     theme_bw() +
     annotate(geom = 'text', x = 1, y = c(1:5), label = 'L', color = 'white') +
     annotate(geom = 'text', x = c(2:5), y = 1, label = 'L', color = 'white') +
     annotate(geom = 'text', x = 2, y = c(3:5), label = 'M', color = 'white') +
     annotate(geom = 'text', x = 2, y = 2, label = 'L', color = 'white') +
     annotate(geom = 'text', x = c(3:5), y = 2, label = 'M', color = 'white') +
     annotate(geom = 'text', x = 3, y = 3, label = 'M', color = 'white') +
     annotate(geom = 'text', x = 3, y = c(4,5), label = 'H', color = 'white') +
     annotate(geom = 'text', x = c(4,5), y = 3, label = 'H', color = 'white') +
     annotate(geom = 'text', x = 4, y = 4, label = 'H', color = 'white') +
     annotate(geom = 'text', x = c(4,5), y = 5, label = 'E', color = 'white') +
     annotate(geom = 'text', x = 5, y = 4, label = 'E', color = 'white') +
     geom_point(data = pi_df1, aes(x = exposure, y = sensitivity), position = 'jitter') +
  facet_wrap(~bioregion, labeller = bioregion_labeller) +
     geom_label_repel(data = pi_df_top3 , aes(label = threat, color = type), fill = 'white') +
     scale_color_discrete(guide = 'none') + 
  theme(axis.title.x = element_text(size = 12, face = 'bold'),
                  axis.title.y = element_text(size = 12, face = 'bold'),
                  legend.title = element_text(size = 12, face = 'bold')) + 
  xlab('Exposure') + 
  ylab('Sensitivity')

table3 <- pi_df1 %>% select(-c('type','rank')) %>% 
  rename('CV_exposure'='cv.x', 'CV_sensitivity' = 'cv.y') %>% 
  pivot_wider(names_from = bioregion, values_from = c(exposure, CV_exposure, sensitivity, CV_sensitivity, potential_impact, pi))




```

Top Figure: Potential impact scores of each threat across bioregions.

Bottom Figure: Risk matrix of exposure and sensitivity for each bioregions. The top three stressors, based on potential impact, for each bioregion are labeled. 
* dr = Dredging, cd = Coastal development, rain = change in rainfall pattern, ar = Agricuture run-off, sst = Increase in sea-surface temperature, tra = Trawling, of = overfishing, ao = Ocean acidification, uir = Urban/Industrial run-off, slr = Sea-level rise 

```{r 4, echo=FALSE, warning=FALSE}
par(mar = c(4, 4, .1, .1))
th_pi_plot
pi_plot1
```


Table 1: Mean, SE and median **potential impact** scores per *bioregion*

Table 2: Mean, SE and median **potential impact** scores per *threat*

```{r 5, echo=FALSE}
bio_pi %>% arrange(-median) %>% kable()
th_pi %>% group_by(type) %>% summarise(mean = round(mean(mean),2),
                                         median = round(median(median),2)) %>% kable()
th_pi %>% arrange(-median) %>% kable()

pi_cc_df %>% 
  group_by(threat) %>% 
  summarise(no_rows = length(threat)) %>% 
  arrange(-no_rows)
tot_pi %>% kable()
```

## Certainty tables

```{r certainty_calculation, echo=FALSE, message=FALSE, warning=FALSE}
## Certainty dataset

cer <- scientist %>% select(matches('.*_cer$')) %>% select(-contains('other'))
colnames(cer) <- sub("_cer", "", colnames(cer))

cer_long <- cer %>% 
  select(sp_sst_b1:rec_drg_b6) %>% 
  pivot_longer(everything(), 
               names_to = c('index','threat','bioregion'), 
               names_pattern = '(.*)_(.*)_(b[1-6])', 
               values_to = 'certainty') %>% 
  filter(!is.na(certainty))

bio_cer_plot <- cer_long %>% 
    mutate(bioregion = fct_reorder(bioregion, certainty, .fun = 'median')) %>% 
    filter(!is.na(certainty))  %>% 
    ggplot(aes(x = reorder(bioregion, -certainty), y = certainty)) +
    geom_boxplot() + 
    theme_pubr() +
    xlab('Bioregions (Short et al., 2007)') +
    ylab("Certainty") +
    labs(color = 'Threat') +
    theme(axis.title.x = element_text(face = 'bold', size = 12, margin = margin(t = 10)),
          axis.title.y = element_text(face = 'bold', size = 12),
          axis.text = element_text(size = 12),
          axis.text.x = element_text(angle = 90, vjust = 0.2, hjust = 0.95),
          legend.title = element_text(size = 12, face = 'bold'),
          legend.text = element_text(size = 12)) +
    scale_x_discrete(labels = c('Temperate Atlantic','Mediterranean',
                                'Temperate Pacific','Temperate Southern Oceans',
                                'Tropical Indo-Pacific','Tropical Atlantic'))

bio_cer <- cer_long %>% 
  group_by(bioregion) %>% 
  summarise(mean = round(mean(certainty),2),
            SE = round(stderr(certainty),2),
            median = round(median(certainty),2)) %>% 
  mutate(certainty = round(mean,0),
            certainty_q = ifelse(certainty == 1, 'Low',
                                ifelse(certainty == 2, 'Medium',
                                      ifelse(certainty == 3, 'High', 'Very high'))))

th_cer_plot <- cer_long %>% 
    mutate(threat = fct_reorder(threat, certainty, .fun = 'median')) %>% 
    filter(!is.na(certainty))  %>% 
    ggplot(aes(x = reorder(threat, -certainty), y = certainty)) +
    geom_boxplot() + 
    theme_pubr() +
    xlab('Threats') +
    ylab("Certainty") +
    theme(axis.title.x = element_text(face = 'bold', size = 12, margin = margin(t = 10)),
          axis.title.y = element_text(face = 'bold', size = 12),
          axis.text = element_text(size = 12),
          axis.text.x = element_text(angle = 90, vjust = 0.2, hjust = 0.95),
          legend.title = element_text(size = 12, face = 'bold'),
          legend.text = element_text(size = 12))

th_cer <- cer_long %>% 
  group_by(threat) %>% 
  summarise(mean = round(mean(certainty),2),
            SE = round(stderr(certainty),2),
            median = round(median(certainty),2)) %>% 
  mutate(certainty = round(mean,0),
            certainty_q = ifelse(certainty == 1, 'Low',
                                ifelse(certainty == 2, 'Medium',
                                      ifelse(certainty == 3, 'High', 'Very high'))))



in_cer_plot <- cer_long %>% 
    mutate(bioregion = fct_reorder(index, certainty, .fun = 'median')) %>% 
    filter(!is.na(certainty))  %>% 
    ggplot(aes(x = reorder(index, -certainty), y = certainty)) +
    geom_boxplot() + 
    theme_pubr() +
    xlab('Index') +
    ylab("Certainty") +
    theme(axis.title.x = element_text(face = 'bold', size = 12, margin = margin(t = 10)),
          axis.title.y = element_text(face = 'bold', size = 12),
          axis.text = element_text(size = 12),
          axis.text.x = element_text(angle = 90, vjust = 0.2, hjust = 0.95),
          legend.title = element_text(size = 12, face = 'bold'),
          legend.text = element_text(size = 12))

in_cer <- cer_long %>% 
  group_by(index) %>% 
  summarise(mean = round(mean(certainty),2),
            SE = round(stderr(certainty),2),
            median = round(median(certainty),2)) %>% 
  mutate(certainty = round(mean,0),
            certainty_q = ifelse(certainty == 1, 'Low',
                                ifelse(certainty == 2, 'Medium',
                                      ifelse(certainty == 3, 'High', 'Very high'))))



top_cer <- cer_long %>% 
    group_by(threat, bioregion) %>% 
    summarise(mean = round(mean(certainty),2),
              SE = round(stderr(certainty),2)) %>% arrange(desc(mean)) %>% head(10)
tot_cer <- cer_long %>% 
    group_by(index, threat, bioregion) %>% 
    summarise(mean = round(mean(certainty),2),
              SE = round(stderr(certainty),2)) %>% arrange(desc(mean))
tot_cer <- tot_cer %>% mutate(cer_q = ifelse(mean >= 3.5, 'Very High',
                                  ifelse(mean >= 2.5 & mean <3.5, 'High',
                                         ifelse(mean >=1.5 & mean < 2.5, 'Medium', 'Low'))))

cer_3_b1 <- tot_cer %>% filter(bioregion == 'b1') %>% arrange(desc(mean)) %>% head(3)
cer_3_b2 <- tot_cer %>% filter(bioregion == 'b2') %>% arrange(desc(mean)) %>% head(3)
cer_3_b3 <- tot_cer %>% filter(bioregion == 'b3') %>% arrange(desc(mean)) %>% head(3)
cer_3_b4 <- tot_cer %>% filter(bioregion == 'b4') %>% arrange(desc(mean)) %>% head(3)
cer_3_b5 <- tot_cer %>% filter(bioregion == 'b5') %>% arrange(desc(mean)) %>% head(3)
cer_3_b6 <- tot_cer %>% filter(bioregion == 'b6') %>% arrange(desc(mean)) %>% head(3)


```

Table 1: Mean, SE and median **certainty scores** scores per *bioregion*

Table 2: Mean, SE and median **certainty scores** scores per *threat*

Table 3: Mean, SE and median **certainty scores** scores per *index*

```{r 6, echo=FALSE}
bio_cer %>% arrange(-median) %>%  kable()
th_cer %>% arrange(-median) %>%  kable()
in_cer %>% arrange(-median) %>%  kable()

```

## Cumulative impact type and threats combination

Marginal means from log linear model:


```{r cumulative_impact, echo=FALSE, message=FALSE, warning=FALSE}
cumulative <- scientist %>% 
  select(ht_.ht:ao_hy_cer) %>% 
  mutate(across(matches('.*_cer$'), ~ as.numeric(as.character(.x))))

colnames(cumulative) <- sub('_\\.','_', colnames(cumulative))

cumulative <- cumulative %>% mutate(id = factor(paste('ID',1:n())))

cumulative_long <- cumulative %>% 
  select(-matches('_cer$')) %>% 
  pivot_longer(ht_ht:ao_hy, names_to = 'com_th', values_to = 'cum_imp')

cumulative_cert <- cumulative %>% select(matches('_cer$'), id)
colnames(cumulative_cert) <- sub("_cer","", colnames(cumulative_cert))

certainty_long <-cumulative_cert %>% 
  pivot_longer(ht_ht:ao_hy, 
               names_to = 'com_th', values_to = 'cert')

# Dataset of cumulative impacts of stressor combinations with certainty
cumulative_long_cer <- left_join(cumulative_long,certainty_long) %>% 
  filter(!is.na(cum_imp) & !is.na(cert)) %>% 
  mutate(com_th = as.factor(com_th),
         cum_imp = as.factor(cum_imp))

# Weighted counts based on certainty
weigh_cum <- cumulative_long_cer[rep(seq(nrow(cumulative_long_cer)), cumulative_long_cer$cert),]
weigh_cum <- droplevels(weigh_cum)

cum_df <- weigh_cum %>% group_by(com_th, cum_imp) %>% summarise(Freq = n())
cum_df <- cum_df %>% group_by(com_th) %>% 
     mutate(rank = rank(Freq, na.last = FALSE)) %>% ungroup() %>% 
  mutate(cum_imp = ordered(cum_imp, levels = c('Synergistic','Additive', 'Antagonistic')))

cum_imp_prop <- as.data.frame(prop.table(table(weigh_cum$com_th, weigh_cum$cum_imp),1))

sel_order <- 
  cum_df %>% 
  filter(cum_imp == "Synergistic") %>% 
  arrange(Freq) %>% 
  mutate(com_th = factor(com_th))

sel_order2 <- 
  cum_df %>% 
  filter(cum_imp == "Antagonistic") %>% 
  arrange(Freq) %>% 
  mutate(com_th = factor(com_th))

# Create a text
grob <- grobTree(textGrob("Eutrophication +
                          High suspended sediments + 
                          Hypoxia + 
                          High temperature", x=0.8,  y = 0.7, hjust=0,
  gp=gpar(fontsize=13, fontface="bold")))
# Plot

cumulative_plot <- cum_df %>% 
  mutate(com_th = factor(com_th, levels = sel_order$com_th, ordered = TRUE)) %>%  
  filter(!is.na(com_th)) %>% 
  ggplot(aes(x = com_th, y = Freq),  group = com_th) + 
  geom_bar(stat = 'identity') +
  facet_grid(~cum_imp) +
     scale_y_continuous(name = 'Weighted counts') +
     scale_fill_discrete(name = 'Cumulative impact') +
     scale_x_discrete(name = 'Threats combination') + 
  theme_pubr() + 
  coord_flip()

fig5 <- cum_df %>% 
     mutate(com_th = factor(com_th, levels = sel_order$com_th, ordered = TRUE)) %>%  
     filter(!is.na(com_th)) %>% 
     ggplot(aes(x = com_th, y = Freq, fill = cum_imp),  group = com_th) + 
     geom_bar(stat = 'identity', position = position_stack(), width = 0.7) +
     scale_y_continuous(name = 'Weighted counts', limits = c(0,50), expand = c(0,0)) +
     scale_fill_discrete(name = 'Cumulative impact') +
     scale_x_discrete(name = 'Threats combination', 
                      breaks = c('ir_hss','hss_ht'), 
                      labels = c('Increased irradiance\n+\nHigh suspended sediments ', 
                                 'Eutrophication\n+\nHigh suspended sediments\n+\nHypoxia\n+\nHigh temperature')) + 
     theme_pubr() + 
     coord_flip() +
  theme(axis.text.y = element_text(size = 10),
        axis.ticks.y = element_blank(),
        axis.title.x = element_text(size = 12, face = 'bold'),
                  axis.title.y = element_text(size = 12, face = 'bold'),
        legend.title = element_text(size = 12, face = 'bold')) + 
  geom_rect(aes(ymin = 0, ymax = 46, xmin = 22.5, xmax = 28.5),fill = 'red', alpha = 0.005) + 
  annotate('text', x = 25, y = 47, label = '*', size = 12, colour = 'red') + 
  annotate('text', x = 11.5, y = 28, label = '*', size = 12, colour = 'blue')
  
cum_df %>% 
     mutate(com_th = factor(com_th, levels = sel_order$com_th, ordered = TRUE)) %>%  
     filter(!is.na(com_th)) %>% 
     ggplot(aes(x = com_th, y = Freq, fill = cum_imp),  group = com_th) + 
     geom_bar(stat = 'identity', position = position_stack()) +
     scale_y_continuous(name = 'Weighted counts', limits = c(0,50)) +
     scale_fill_discrete(name = 'Cumulative impact') +
     scale_x_discrete(name = 'Threats combination') + 
     theme_pubr() + 
     coord_flip() +
  theme(axis.text.y = element_text(),
        axis.ticks.y = element_blank(),
        axis.title.x = element_text(size = 12, face = 'bold'),
                  axis.title.y = element_text(size = 12, face = 'bold'),
        legend.title = element_text(size = 12, face = 'bold')) + 
  geom_rect(aes(ymin = 0, ymax = 46, xmin = 22.5, xmax = 28.5),fill = 'red', alpha = 0.005) + 
  annotate('text', x = 25, y = 47, label = '*', size = 12, colour = 'red') + 
  annotate('text', x = 11.5, y = 28, label = '*', size = 12, colour = 'blue')

 

# Log linear model
#brms - log linear models
# Interaction between threats combination and type of threat is the predictor, the count is response, cert is the weighting
cumulative_model <- glm(Freq ~ com_th:cum_imp, data = cum_df, family = poisson(link = 'log'))
#cumulative.resid <-simulateResiduals(cumulative_model, plot = TRUE)
#testDispersion(cumulative.resid)
emmeans(cumulative_model, pairwise ~ cum_imp|com_th, type = 'response')

cum_table <- table(weigh_cum$com_th, weigh_cum$cum_imp)
cum_chi <- chisq.test(cum_table)
#corrplot(cum_chi$residuals, is.cor = FALSE)
```

# Site managers response analysis 
## Exposure, adaptive capacities and dependencies values from managers

```{r calculation_manager, echo=FALSE, message=FALSE, warning=FALSE}
exposure_m <- managers_summary_long %>% 
  group_by(wh,threat) %>% 
  summarise(exposure = mean(value, na.rm = TRUE),
            SE = stderr(value)) %>% 
  filter(!is.na(exposure))

exposure_m <- exposure_m %>% mutate(exposure1_m = round(exposure,0),
                    exposure_q_m = ifelse(exposure1_m == 1, 'Very Low',
                                        ifelse(exposure1_m == 2, 'Low',
                                               ifelse(exposure1_m == 3, 'Moderate',
                                                      ifelse(exposure1_m == 4, 'High', 'Very high')))))
exposure_m <- exposure_m %>% 
  mutate(type = ifelse(threat == 'mh'|threat == 'storm'|threat == 'dr'|threat == 'slr'|threat == 'sst'|threat == 'rain'|threat == 'ao','climate_change','human' ))

th_ex_m_plot <- exposure_m %>% ggplot(aes(x = reorder(threat, -exposure), y = exposure)) +
    geom_boxplot()

wh_ex_plot <- exposure_m %>% ggplot(aes(x = reorder(wh, -exposure), y = exposure)) +
    geom_boxplot() + coord_flip()

top_3_cc <- exposure_m %>%
  filter(type == 'climate_change') %>% 
  group_by(wh) %>% 
  arrange(desc(exposure)) %>% 
  slice(1:3)
top_3_h <- exposure_m %>%
  filter(type == 'human') %>% 
  group_by(wh) %>% 
  arrange(desc(exposure)) %>% 
  slice(1:3)

wh_exp <- top_3_cc %>% 
  group_by(wh) %>% 
  summarise(mean = round(mean(exposure),2),
            SE = round(stderr(exposure),2)) %>% 
  mutate(exposure = round(mean,0),
            exposure_q_m = ifelse(exposure == 1, 'Very Low',
                                ifelse(exposure == 2, 'Low',
                                       ifelse(exposure == 3, 'Moderate',
                                              ifelse(exposure == 4, 'High', 'Very high')))))
wh_exp_h <- top_3_h %>% 
  group_by(wh) %>% 
  summarise(mean = round(mean(exposure),2),
            SE = round(stderr(exposure),2)) %>% 
  mutate(exposure = round(mean,0),
            exposure_q_m = ifelse(exposure == 1, 'Very Low',
                                ifelse(exposure == 2, 'Low',
                                       ifelse(exposure == 3, 'Moderate',
                                              ifelse(exposure == 4, 'High', 'Very high')))))



wh_ex_plot <- top_3_cc %>% 
    mutate(wh = fct_reorder(wh, exposure, .fun = 'median')) %>% 
    filter(wh != 'x')  %>% 
    ggplot(aes(x = reorder(wh, exposure), y = exposure)) +
    geom_boxplot() + 
    theme_pubr() +
    xlab('World Heritage seagrass habitats') +
    ylab("Exposure") +
    theme(axis.title.x = element_text(face = 'bold', size = 12, margin = margin(t = 10)),
          axis.title.y = element_text(face = 'bold', size = 12),
          axis.text = element_text(size = 12),
          axis.text.x = element_text(angle = 90, vjust = 0.2, hjust = 0.95),
          legend.title = element_text(size = 12, face = 'bold'),
          legend.text = element_text(size = 12)) +
    scale_y_continuous(limits = c(0,5), breaks = c(1,2,3,4,5), labels = c('Very Low', 'Low','Moderate','High','Very High')) +
    coord_flip() + 
  theme(axis.text.x = element_text(angle = 0))

# Adaptive capacity
ad_cap <- managers %>% select(matches('^ad_.*'), wh)
ad_cap <- ad_cap %>% mutate(across(.cols = matches('^ad_.*'), ~ as.numeric(as.character(.x))))
ad_cap <- ad_cap %>% group_by(wh) %>% summarise(across(.cols = matches('^ad_.*'), ~ mean(.x, na.rm = TRUE))) %>% filter(!is.na(ad_res))
adaptive_capacity <- ad_cap %>% 
  group_by(wh) %>% 
  summarise(ad_cap = round(mean(c(ad_res,ad_sci,ad_cc), na.rm = TRUE),0))
adaptive_capacity <- adaptive_capacity %>% mutate(ad_cap_q = ifelse(ad_cap == 4, 'High',
                                                ifelse(ad_cap == 3, 'Moderate',
                                                        ifelse(ad_cap == 2, 'Low', 'None'))))
dependency <- managers %>% select(OUV,COM, wh)
dependency <- dependency %>% 
  group_by(wh) %>% 
  summarise(ou_dep = round(mean(OUV, na.rm = TRUE),0), com_dep = round(mean(COM, na.rm = TRUE),0)) %>%
  filter(!is.na(ou_dep)|!is.na(com_dep))

dependency <- dependency %>% mutate(ouv_dep_q = ifelse(ou_dep == 5, 'Very High',
                                         ifelse(ou_dep == 4, 'High',
                                                ifelse(ou_dep == 3, 'Moderate',
                                                       ifelse(ou_dep == 2, 'Low', 'Potential')))),
                                    com_dep_q = ifelse(com_dep == 4, 'Very High',
                                         ifelse(com_dep == 3, 'High',
                                                ifelse(com_dep == 2, 'Moderate',
                                                       ifelse(com_dep == 1, 'Low', 'No dependecy')))))




# Most common direct-anthropogenic threats by exposure
#exposure_m %>% 
  #filter(type == 'human' & wh != 'x') %>% 
  #arrange(-exposure) %>% 
  #slice(1:3) %>% 
  #ungroup() %>% 
  #group_by(threat) %>% 
  #summarise(no_rows = length(threat)) %>% 
  #arrange(-no_rows)

```

Table 1: top 3 climate change threats, based on exposure scores, for each WH seagrass habitat

Table 2: top 3 anthropogenic threats, based on exposure scores, for each WH seagrass habitat

Table 3: averaged exposure scores for each wh seagrass habitat

Table 4: Most common climate change threats (by exposure) appearing in the top 3 stressor of WH seagrass habitats

Table 5: Most common anthropogenic threats (by exposure) appearing in the top 3 stressor of WH seagrass habitats


```{r 7, echo=FALSE}
top_3_cc %>% filter(wh != 'x') %>%  kable()
top_3_h %>% filter(wh != 'x') %>%  kable()

wh_exp %>% filter(wh != 'x') %>% arrange(-mean) %>% kable()
#wh_exp_h %>% filter(wh!='x') %>% arrange(-mean) %>% kable()

exposure_m %>% 
  filter(type == 'climate_change' & wh != 'x') %>% 
  arrange(-exposure) %>% 
  slice(1:3) %>% 
  ungroup() %>% 
  group_by(threat) %>% 
  summarise(no_rows = length(threat)) %>% 
  arrange(-no_rows) %>% kable()

exposure_m %>% 
  filter(type == 'human' & wh != 'x') %>% 
  arrange(-exposure) %>% 
  slice(1:3) %>% 
  ungroup() %>% 
  group_by(threat) %>% 
  summarise(no_rows = length(threat)) %>% 
  arrange(-no_rows) %>% kable()

```



# Vulnerability idices

```{r Vulnerability indeces, message=FALSE, warning=FALSE, include=FALSE}
aldabra_s <- sensitivity %>% 
  filter(bioregion == 'b5', 
         threat %in% c('mh','dr','sst','srba','srbp','lcba')) %>% 
  select(threat,sensitivity,sensitivity_q,type)

aldabra_e_m <- exposure_m %>% 
  filter(wh == 'Aldabra Atoll', 
         threat %in% c('mh','dr','sst','srba','srbp','lcba')) %>% 
  ungroup() %>% 
  select(threat,exposure,exposure_q_m,type)

aldabra_e_s <- exposure %>% 
  filter(bioregion == 'b5', 
         threat %in% c('mh','dr','sst','srba','srbp','lcba')) %>% 
  rename(exposure_s = exposure) %>% 
  select(threat, exposure_s, exposure_q,type)

aldabra <- full_join(aldabra_s, aldabra_e_m)
aldabra <- full_join(aldabra, aldabra_e_s)
aldabra <- aldabra %>% mutate(potential_impact = exposure*sensitivity)

aldabra <- aldabra %>% 
    mutate(pi = ifelse(potential_impact >= 20, 'Extreme', 
                                     ifelse(potential_impact > 10 & potential_impact < 20, 'High',
                                            ifelse(potential_impact > 5 & potential_impact <= 10, 'Moderate', 'Low'))))

pi_aldabra <- aldabra %>% 
  group_by(type) %>% 
  summarise(pi = mean(potential_impact)) %>% 
  mutate(potential_impact = ifelse(pi >= 20, 'Extreme', 
                              ifelse(pi > 10 & pi < 20, 'High',
                                     ifelse(pi > 5 & pi <= 10, 'Moderate', 'Low'))))

ad_aldabra <- adaptive_capacity %>% filter(wh == 'Aldabra Atoll') %>% select(-wh)
pi_aldabra_cc <-  pi_aldabra %>% filter(type == 'climate_change')

vul_aldabra <- full_join(pi_aldabra_cc, ad_aldabra, by = character())

vul_aldabra[sapply(vul_aldabra, is.character)] <- lapply(vul_aldabra[sapply(vul_aldabra, is.character)], 
as.factor)

vul_aldabra <- vul_aldabra %>% mutate(se_vu = ifelse(potential_impact == 'Low', 'Low',
                                      ifelse(potential_impact == 'Moderate' & ad_cap < 4, 'Moderate',
                                             ifelse(potential_impact == 'Moderate' & ad_cap == 4, 'Low',
                                                    ifelse(potential_impact == 'High' & ad_cap > 2, 'Moderate',
                                                           ifelse(potential_impact == 'High' & ad_cap < 3, 'High',
                                                                  ifelse(potential_impact == 'Extreme' & ad_cap == 4, 'Moderate',
                                                                         ifelse(potential_impact == 'Extreme' & ad_cap == 1,
                                                                                'Extreme', 'High'))))))))
dep_aldabra <- dependency %>% filter(wh == 'Aldabra Atoll') %>% select(-wh)
vul_aldabra <- full_join(vul_aldabra, dep_aldabra, by = character())

aldabra %>% kable()
pi_aldabra %>% kable()
vul_aldabra %>% kable()

###############################

belize_s <- sensitivity %>% 
  filter(bioregion == 'b2', 
         threat %in% c('storm','sst','srba','swq','cd')) %>% 
   select(threat,sensitivity,sensitivity_q,type)

belize_e_m <- exposure_m %>% 
  filter(wh == 'Belize Barrier Reef Reserve System', 
         threat %in% c('storm','sst','srba','swq','cd')) %>% 
  ungroup() %>% 
  select(threat,exposure,exposure_q_m,type)

belize_e_s <- exposure %>% 
  filter(bioregion == 'b2', 
         threat %in% c('storm','sst','srba','swq','cd')) %>% rename(exposure_s = exposure) %>% 
  select(threat, exposure_s, exposure_q,type)

belize <- full_join(belize_s, belize_e_m)
belize <- full_join(belize, belize_e_s)
belize <- belize %>% mutate(potential_impact = exposure*sensitivity)


belize <- belize %>% 
    mutate(pi = ifelse(potential_impact >= 20, 'Extreme', 
                                     ifelse(potential_impact > 10 & potential_impact < 20, 'High',
                                            ifelse(potential_impact > 5 & potential_impact <= 10, 'Moderate', 'Low'))))
pi_belize <- belize %>% 
  group_by(type) %>% 
  summarise(pi = mean(potential_impact)) %>% 
  mutate(potential_impact = ifelse(pi >= 20, 'Extreme', 
                              ifelse(pi > 10 & pi < 20, 'High',
                                     ifelse(pi > 5 & pi <= 10, 'Moderate', 'Low'))))

ad_belize <- adaptive_capacity %>% filter(wh == 'Belize Barrier Reef Reserve System') %>% select(-wh)
pi_belize_cc <-  pi_belize %>% filter(type == 'climate_change')
vul_belize <- full_join(pi_belize_cc, ad_belize, by = character())

vul_belize[sapply(vul_belize, is.character)] <- lapply(vul_belize[sapply(vul_belize, is.character)], 
as.factor)

vul_belize <- vul_belize %>% mutate(se_vu = ifelse(potential_impact == 'Low', 'Low',
                                      ifelse(potential_impact == 'Moderate' & ad_cap < 4, 'Moderate',
                                             ifelse(potential_impact == 'Moderate' & ad_cap == 4, 'Low',
                                                    ifelse(potential_impact == 'High' & ad_cap > 2, 'Moderate',
                                                           ifelse(potential_impact == 'High' & ad_cap < 3, 'High',
                                                                  ifelse(potential_impact == 'Extreme' & ad_cap == 4, 'Moderate',
                                                                         ifelse(potential_impact == 'Extreme' & ad_cap == 1,
                                                                                'Extreme', 'High'))))))))
dep_belize <- dependency %>% filter(wh == 'Belize Barrier Reef Reserve System') %>% select(-wh)
vul_belize <- full_join(vul_belize, dep_belize, by = character())

belize %>% kable()
pi_belize %>% kable()
vul_belize %>% kable()


#################

everglades_s <- sensitivity %>% 
  filter(bioregion == 'b2', 
         threat %in% c('slr','sst','ao','srbp','cd','srba')) %>% 
   select(threat,sensitivity,sensitivity_q,type)

everglades_e_m <- exposure_m %>% 
  filter(wh == 'Everglades National Park', 
         threat %in% c('slr','sst','ao','srbp','cd','srba')) %>% 
  ungroup() %>% 
  select(threat,exposure,exposure_q_m,type)

everglades_e_s <- exposure %>% 
  filter(bioregion == 'b2', 
         threat %in% c('slr','sst','ao','srbp','cd','srba')) %>% rename(exposure_s = exposure) %>% 
  select(threat, exposure_s, exposure_q,type)


everglades <- full_join(everglades_s, everglades_e_m)
everglades <- full_join(everglades, everglades_e_s)
everglades <- everglades %>% mutate(potential_impact = exposure*sensitivity)

everglades <- everglades %>% 
    mutate(pi = ifelse(potential_impact >= 20, 'Extreme', 
                                     ifelse(potential_impact > 10 & potential_impact < 20, 'High',
                                            ifelse(potential_impact > 5 & potential_impact <= 10, 'Moderate', 'Low'))))

pi_everglades <- everglades %>% 
  group_by(type) %>% 
  summarise(pi = mean(potential_impact)) %>% 
  mutate(potential_impact = ifelse(pi >= 20, 'Extreme', 
                              ifelse(pi > 10 & pi < 20, 'High',
                                     ifelse(pi > 5 & pi <= 10, 'Moderate', 'Low'))))
ad_everglades <- adaptive_capacity %>% filter(wh == 'Everglades National Park') %>% select(-wh)
pi_everglades_cc <-  pi_everglades %>% filter(type == 'climate_change')
vul_everglades <- full_join(pi_everglades_cc, ad_everglades, by = character())

vul_everglades[sapply(vul_everglades, is.character)] <- lapply(vul_everglades[sapply(vul_everglades, is.character)], 
as.factor)

vul_everglades <- vul_everglades %>% mutate(se_vu = ifelse(potential_impact == 'Low', 'Low',
                                      ifelse(potential_impact == 'Moderate' & ad_cap < 4, 'Moderate',
                                             ifelse(potential_impact == 'Moderate' & ad_cap == 4, 'Low',
                                                    ifelse(potential_impact == 'High' & ad_cap > 2, 'Moderate',
                                                           ifelse(potential_impact == 'High' & ad_cap < 3, 'High',
                                                                  ifelse(potential_impact == 'Extreme' & ad_cap == 4, 'Moderate',
                                                                         ifelse(potential_impact == 'Extreme' & ad_cap == 1,
                                                                                'Extreme', 'High'))))))))
dep_everglades <- dependency %>% filter(wh == 'Everglades National Park') %>% select(-wh)
vul_everglades <- full_join(vul_everglades, dep_everglades, by = character())

everglades %>% kable()
pi_everglades %>% kable()
vul_everglades %>% kable ()

#####################

gbr_s <- sensitivity %>% 
  filter(bioregion == 'b5', 
         threat %in% c('slr','sst','ao','srbp','lcba','srba')) %>% 
   select(threat,sensitivity,sensitivity_q,type)

gbr_e_m <- exposure_m %>% 
  filter(wh == 'Great Barrier Reef', 
         threat %in% c('slr','sst','ao','srbp','lcba','srba')) %>% 
  ungroup() %>% 
  select(threat,exposure,exposure_q_m,type)


gbr_e_s <- exposure %>% 
  filter(bioregion == 'b5', 
         threat %in% c('slr','sst','ao','srbp','lcba','srba')) %>% rename(exposure_s = exposure) %>% 
  select(threat, exposure_s, exposure_q,type)



gbr <- full_join(gbr_s, gbr_e_m)
gbr <- full_join(gbr, gbr_e_s)
gbr <- gbr %>% mutate(potential_impact = exposure*sensitivity)

gbr <- gbr %>% 
    mutate(pi = ifelse(potential_impact >= 20, 'Extreme', 
                                     ifelse(potential_impact > 10 & potential_impact < 20, 'High',
                                            ifelse(potential_impact > 5 & potential_impact <= 10, 'Moderate', 'Low'))))

pi_gbr <- gbr %>% 
  group_by(type) %>% 
  summarise(pi = mean(potential_impact)) %>% 
  mutate(potential_impact = ifelse(pi >= 20, 'Extreme', 
                              ifelse(pi > 10 & pi < 20, 'High',
                                     ifelse(pi > 5 & pi <= 10, 'Moderate', 'Low'))))
ad_gbr <- adaptive_capacity %>% filter(wh == 'Great Barrier Reef') %>% select(-wh)
pi_gbr_cc <-  pi_gbr %>% filter(type == 'climate_change')
vul_gbr <- full_join(pi_gbr_cc, ad_gbr, by = character())

vul_gbr[sapply(vul_gbr, is.character)] <- lapply(vul_gbr[sapply(vul_gbr, is.character)], 
as.factor)

vul_gbr <- vul_gbr %>% mutate(se_vu = ifelse(potential_impact == 'Low', 'Low',
                                      ifelse(potential_impact == 'Moderate' & ad_cap < 4, 'Moderate',
                                             ifelse(potential_impact == 'Moderate' & ad_cap == 4, 'Low',
                                                    ifelse(potential_impact == 'High' & ad_cap > 2, 'Moderate',
                                                           ifelse(potential_impact == 'High' & ad_cap < 3, 'High',
                                                                  ifelse(potential_impact == 'Extreme' & ad_cap == 4, 'Moderate',
                                                                         ifelse(potential_impact == 'Extreme' & ad_cap == 1,
                                                                                'Extreme', 'High'))))))))
dep_gbr <- dependency %>% filter(wh == 'Great Barrier Reef') %>% select(-wh)
vul_gbr <- full_join(vul_gbr, dep_gbr, by = character())

gbr %>% kable()
pi_gbr %>% kable()
vul_gbr %>% kable()

##################################


high_coast_s <- sensitivity %>% 
  filter(bioregion == 'b1', 
         threat %in% c('slr','sst','rain','cd','ar','drg')) %>% 
   select(threat,sensitivity,sensitivity_q,type)


high_coast_e_m <- exposure_m %>% 
  filter(wh == 'High Coast Kvarken Archipelago', 
         threat %in% c('slr','sst','rain','cd','ar','drg')) %>% 
  ungroup() %>% 
  select(threat,exposure,exposure_q_m,type)

high_coast_e_s <- exposure %>% 
  filter(bioregion == 'b1', 
         threat %in% c('slr','sst','rain','cd','ar','drg')) %>% rename(exposure_s = exposure) %>% 
  select(threat, exposure_s, exposure_q,type)

high_coast <- full_join(high_coast_s, high_coast_e_m)
high_coast <- full_join(high_coast, high_coast_e_s)
high_coast <- high_coast %>% mutate(potential_impact = exposure*sensitivity)

high_coast <- high_coast %>% 
    mutate(pi = ifelse(potential_impact >= 20, 'Extreme', 
                                     ifelse(potential_impact > 10 & potential_impact < 20, 'High',
                                            ifelse(potential_impact > 5 & potential_impact <= 10, 'Moderate', 'Low'))))

pi_high_coast <- high_coast %>% 
  group_by(type) %>% 
  summarise(pi = mean(potential_impact)) %>% 
  mutate(potential_impact = ifelse(pi >= 20, 'Extreme', 
                              ifelse(pi > 10 & pi < 20, 'High',
                                     ifelse(pi > 5 & pi <= 10, 'Moderate', 'Low'))))
ad_high_coast <- adaptive_capacity %>% filter(wh == 'High Coast Kvarken Archipelago') %>% select(-wh)
pi_high_coast_cc <-  pi_high_coast %>% filter(type == 'climate_change')
vul_high_coast <- full_join(pi_high_coast_cc, ad_high_coast, by = character())

vul_high_coast[sapply(vul_high_coast, is.character)] <- lapply(vul_high_coast[sapply(vul_high_coast, is.character)], 
as.factor)

vul_high_coast <- vul_high_coast %>% mutate(se_vu = ifelse(potential_impact == 'Low', 'Low',
                                      ifelse(potential_impact == 'Moderate' & ad_cap < 4, 'Moderate',
                                             ifelse(potential_impact == 'Moderate' & ad_cap == 4, 'Low',
                                                    ifelse(potential_impact == 'High' & ad_cap > 2, 'Moderate',
                                                           ifelse(potential_impact == 'High' & ad_cap < 3, 'High',
                                                                  ifelse(potential_impact == 'Extreme' & ad_cap == 4, 'Moderate',
                                                                         ifelse(potential_impact == 'Extreme' & ad_cap == 1,
                                                                                'Extreme', 'High'))))))))
dep_high_coast <- dependency %>% filter(wh == 'High Coast Kvarken Archipelago') %>% select(-wh)
vul_high_coast <- full_join(vul_high_coast, dep_high_coast, by = character())

high_coast %>% kable()
pi_high_coast %>% kable()
vul_high_coast %>% kable()

###############################################################

ibiza_s <- sensitivity %>% 
  filter(bioregion == 'b3', 
         threat %in% c('mh','sst','rain','srbp','srba','drg')) %>% 
   select(threat,sensitivity,sensitivity_q,type)

ibiza_e_m <- exposure_m %>% 
  filter(wh == 'Ibiza, Biodiversity and Culture', 
         threat %in% c('mh','sst','rain','srbp','srba','drg')) %>% 
  ungroup() %>% 
  select(threat,exposure,exposure_q_m,type)

ibiza_e_s <- exposure %>% 
  filter(bioregion == 'b3', 
         threat %in% c('mh','sst','rain','srbp','srba','drg')) %>% rename(exposure_s = exposure) %>% 
  select(threat, exposure_s, exposure_q,type)

ibiza <- full_join(ibiza_s, ibiza_e_m)
ibiza <- full_join(ibiza, ibiza_e_s)
ibiza <- ibiza %>% mutate(potential_impact = exposure*sensitivity)

ibiza <- ibiza %>% 
    mutate(pi = ifelse(potential_impact >= 20, 'Extreme', 
                                     ifelse(potential_impact > 10 & potential_impact < 20, 'High',
                                            ifelse(potential_impact > 5 & potential_impact <= 10, 'Moderate', 'Low'))))
pi_ibiza <- ibiza %>% 
  group_by(type) %>% 
  summarise(pi = mean(potential_impact, na.rm = TRUE)) %>% 
  mutate(potential_impact = ifelse(pi >= 20, 'Extreme', 
                              ifelse(pi > 10 & pi < 20, 'High',
                                     ifelse(pi > 5 & pi <= 10, 'Moderate', 'Low'))))
ad_ibiza <- adaptive_capacity %>% filter(wh == 'Ibiza, Biodiversity and Culture') %>% select(-wh)
pi_ibiza_cc <-  pi_ibiza %>% filter(type == 'climate_change')
vul_ibiza <- full_join(pi_ibiza_cc, ad_ibiza, by = character())

vul_ibiza[sapply(vul_ibiza, is.character)] <- lapply(vul_ibiza[sapply(vul_ibiza, is.character)], 
as.factor)

vul_ibiza <- vul_ibiza %>% mutate(se_vu = ifelse(potential_impact == 'Low', 'Low',
                                      ifelse(potential_impact == 'Moderate' & ad_cap < 4, 'Moderate',
                                             ifelse(potential_impact == 'Moderate' & ad_cap == 4, 'Low',
                                                    ifelse(potential_impact == 'High' & ad_cap > 2, 'Moderate',
                                                           ifelse(potential_impact == 'High' & ad_cap < 3, 'High',
                                                                  ifelse(potential_impact == 'Extreme' & ad_cap == 4, 'Moderate',
                                                                         ifelse(potential_impact == 'Extreme' & ad_cap == 1,
                                                                                'Extreme', 'High'))))))))
dep_ibiza <- dependency %>% filter(wh == 'Ibiza, Biodiversity and Culture') %>% select(-wh)
vul_ibiza <- full_join(vul_ibiza, dep_ibiza, by = character())

ibiza %>% kable()
pi_ibiza %>% kable()
vul_ibiza %>% kable()


####################################

new_cal_s <- sensitivity %>% 
  filter(bioregion == 'b5', 
         threat %in% c('slr','sst','storm','srbp','cd','mi')) %>% 
   select(threat,sensitivity,sensitivity_q,type)

new_cal_e_m <- exposure_m %>% 
  filter(wh == 'Lagons de Nouvelle-Calédonie', 
         threat %in% c('slr','sst','storm','srbp','cd','mi')) %>% 
  ungroup() %>% 
  select(threat,exposure,exposure_q_m,type)

new_cal_e_s <- exposure %>% 
  filter(bioregion == 'b5', 
         threat %in% c('slr','sst','storm','srbp','cd','mi')) %>% rename(exposure_s = exposure) %>% 
  select(threat, exposure_s, exposure_q,type)

new_cal <- full_join(new_cal_s, new_cal_e_m)
new_cal <- full_join(new_cal, new_cal_e_s)
new_cal <- new_cal %>% mutate(potential_impact = exposure*sensitivity)

new_cal <- new_cal %>% 
    mutate(pi = ifelse(potential_impact >= 20, 'Extreme', 
                                     ifelse(potential_impact > 10 & potential_impact < 20, 'High',
                                            ifelse(potential_impact > 5 & potential_impact <= 10, 'Moderate', 'Low'))))

pi_new_cal <- new_cal %>% 
  group_by(type) %>% 
  summarise(pi = mean(potential_impact, na.rm = TRUE)) %>% 
  mutate(potential_impact = ifelse(pi >= 20, 'Extreme', 
                              ifelse(pi > 10 & pi < 20, 'High',
                                     ifelse(pi > 5 & pi <= 10, 'Moderate', 'Low'))))
ad_new_cal <- adaptive_capacity %>% filter(wh == 'Lagons de Nouvelle-Calédonie') %>% select(-wh)
pi_new_cal_cc <-  pi_new_cal %>% filter(type == 'climate_change')
vul_new_cal <- full_join(pi_new_cal_cc, ad_new_cal, by = character())

vul_new_cal[sapply(vul_new_cal, is.character)] <- lapply(vul_new_cal[sapply(vul_new_cal, is.character)], 
as.factor)

vul_new_cal <- vul_new_cal %>% mutate(se_vu = ifelse(potential_impact == 'Low', 'Low',
                                      ifelse(potential_impact == 'Moderate' & ad_cap < 4, 'Moderate',
                                             ifelse(potential_impact == 'Moderate' & ad_cap == 4, 'Low',
                                                    ifelse(potential_impact == 'High' & ad_cap > 2, 'Moderate',
                                                           ifelse(potential_impact == 'High' & ad_cap < 3, 'High',
                                                                  ifelse(potential_impact == 'Extreme' & ad_cap == 4, 'Moderate',
                                                                         ifelse(potential_impact == 'Extreme' & ad_cap == 1,
                                                                                'Extreme', 'High'))))))))
dep_new_cal <- dependency %>% filter(wh == 'Lagons de Nouvelle-Calédonie') %>% select(-wh)
vul_new_cal <- full_join(vul_new_cal, dep_new_cal, by = character())

new_cal %>% kable()
pi_new_cal %>% kable()
vul_new_cal %>% kable()

#################################################


lord_howe_s <- sensitivity %>% 
  filter(bioregion == 'b6', 
         threat %in% c('ao','dr','rain','srbp','srba','ar')) %>% 
   select(threat,sensitivity,sensitivity_q,type)


lord_howe_e_m <- exposure_m %>% 
  filter(wh == 'Lord Howe Island Group - Lord Howe Island Marine Park', 
         threat %in% c('ao','dr','rain','srbp','srba','ar')) %>% 
  ungroup() %>% 
  select(threat,exposure,exposure_q_m,type)


lord_howe_e_s <- exposure %>% 
  filter(bioregion == 'b6', 
         threat %in% c('ao','dr','rain','srbp','srba','ar')) %>% 
  rename(exposure_s = exposure) %>% 
  select(threat, exposure_s, exposure_q,type)


lord_howe <- full_join(lord_howe_s, lord_howe_e_m)
lord_howe <- full_join(lord_howe, lord_howe_e_s)
lord_howe <- lord_howe %>% mutate(potential_impact = exposure*sensitivity)

lord_howe <- lord_howe %>% 
    mutate(pi = ifelse(potential_impact >= 20, 'Extreme', 
                                     ifelse(potential_impact > 10 & potential_impact < 20, 'High',
                                            ifelse(potential_impact > 5 & potential_impact <= 10, 'Moderate', 'Low'))))
pi_lord_howe <- lord_howe %>% 
  group_by(type) %>% 
  summarise(pi = mean(potential_impact, na.rm = TRUE)) %>% 
  mutate(potential_impact = ifelse(pi >= 20, 'Extreme', 
                              ifelse(pi > 10 & pi < 20, 'High',
                                     ifelse(pi > 5 & pi <= 10, 'Moderate', 'Low'))))
ad_lord_howe <- adaptive_capacity %>% filter(wh == 'Lord Howe Island Group - Lord Howe Island Marine Park') %>% select(-wh)
pi_lord_howe_cc <-  pi_lord_howe %>% filter(type == 'climate_change')
vul_lord_howe <- full_join(pi_lord_howe_cc, ad_lord_howe, by = character())

vul_lord_howe[sapply(vul_lord_howe, is.character)] <- lapply(vul_lord_howe[sapply(vul_lord_howe, is.character)], 
as.factor)

vul_lord_howe <- vul_lord_howe %>% mutate(se_vu = ifelse(potential_impact == 'Low', 'Low',
                                      ifelse(potential_impact == 'Moderate' & ad_cap < 4, 'Moderate',
                                             ifelse(potential_impact == 'Moderate' & ad_cap == 4, 'Low',
                                                    ifelse(potential_impact == 'High' & ad_cap > 2, 'Moderate',
                                                           ifelse(potential_impact == 'High' & ad_cap < 3, 'High',
                                                                  ifelse(potential_impact == 'Extreme' & ad_cap == 4, 'Moderate',
                                                                         ifelse(potential_impact == 'Extreme' & ad_cap == 1,
                                                                                'Extreme', 'High'))))))))
dep_lord_howe <- dependency %>% filter(wh == 'Lord Howe Island Group - Lord Howe Island Marine Park') %>% select(-wh)
vul_lord_howe <- full_join(vul_lord_howe, dep_lord_howe, by = character())

lord_howe %>% kable()
pi_lord_howe %>% kable()
vul_lord_howe %>% kable()
##########################################################

ningaloo_s <- sensitivity %>% 
  filter(bioregion == 'b5', 
         threat %in% c('ao','slr','sst','srbp','srba','of')) %>% 
   select(threat,sensitivity,sensitivity_q,type)


ningaloo_e_m <- exposure_m %>% 
  filter(wh == 'Ningaloo', 
         threat %in% c('ao','slr','sst','srbp','srba','of')) %>% 
  ungroup() %>% 
  select(threat,exposure,exposure_q_m,type)


ningaloo_e_s <- exposure %>% 
  filter(bioregion == 'b5', 
         threat %in% c('ao','slr','sst','srbp','srba','of')) %>% 
  rename(exposure_s = exposure) %>% 
  select(threat, exposure_s, exposure_q,type)


ningaloo <- full_join(ningaloo_s, ningaloo_e_m)
ningaloo <- full_join(ningaloo, ningaloo_e_s)
ningaloo <- ningaloo %>% mutate(potential_impact = exposure*sensitivity)

ningaloo <- ningaloo %>% 
    mutate(pi = ifelse(potential_impact >= 20, 'Extreme', 
                                     ifelse(potential_impact > 10 & potential_impact < 20, 'High',
                                            ifelse(potential_impact > 5 & potential_impact <= 10, 'Moderate', 'Low'))))

pi_ningaloo <- ningaloo %>% 
  group_by(type) %>% 
  summarise(pi = mean(potential_impact, na.rm = TRUE)) %>% 
  mutate(potential_impact = ifelse(pi >= 20, 'Extreme', 
                              ifelse(pi > 10 & pi < 20, 'High',
                                     ifelse(pi > 5 & pi <= 10, 'Moderate', 'Low'))))
ad_ningaloo <- adaptive_capacity %>% filter(wh == 'Ningaloo') %>% select(-wh)
pi_ningaloo_cc <-  pi_ningaloo %>% filter(type == 'climate_change')
vul_ningaloo <- full_join(pi_ningaloo_cc, ad_ningaloo, by = character())

vul_ningaloo[sapply(vul_ningaloo, is.character)] <- lapply(vul_ningaloo[sapply(vul_ningaloo, is.character)], 
as.factor)

vul_ningaloo <- vul_ningaloo %>% mutate(se_vu = ifelse(potential_impact == 'Low', 'Low',
                                      ifelse(potential_impact == 'Moderate' & ad_cap < 4, 'Moderate',
                                             ifelse(potential_impact == 'Moderate' & ad_cap == 4, 'Low',
                                                    ifelse(potential_impact == 'High' & ad_cap > 2, 'Moderate',
                                                           ifelse(potential_impact == 'High' & ad_cap < 3, 'High',
                                                                  ifelse(potential_impact == 'Extreme' & ad_cap == 4, 'Moderate',
                                                                         ifelse(potential_impact == 'Extreme' & ad_cap == 1,
                                                                                'Extreme', 'High'))))))))
dep_ningaloo <- dependency %>% filter(wh == 'Ningaloo') %>% select(-wh)
vul_ningaloo <- full_join(vul_ningaloo, dep_ningaloo, by = character())

ningaloo %>% kable()
pi_ningaloo %>% kable()
vul_ningaloo %>% kable()

####################################



banc_da_s <- sensitivity %>% 
  filter(bioregion == 'b2', 
         threat %in% c('dr','rain','mh','mi','of')) %>% 
   select(threat,sensitivity,sensitivity_q,type)


banc_da_e_m <- exposure_m %>% 
  filter(wh == "Parc National du Banc d'Arguin", 
         threat %in% c('dr','rain','mh','mi','of')) %>% 
  ungroup() %>% 
  select(threat,exposure,exposure_q_m,type)

banc_da_e_s <- exposure %>% 
  filter(bioregion == 'b2', 
         threat %in% c('dr','rain','mh','mi','of')) %>% 
  rename(exposure_s = exposure) %>% 
  select(threat, exposure_s, exposure_q,type)


banc_da <- full_join(banc_da_s, banc_da_e_m)
banc_da <- full_join(banc_da, banc_da_e_s)
banc_da <- banc_da %>% mutate(potential_impact = exposure*sensitivity)

banc_da <- banc_da %>% 
    mutate(pi = ifelse(potential_impact >= 20, 'Extreme', 
                                     ifelse(potential_impact > 10 & potential_impact < 20, 'High',
                                            ifelse(potential_impact > 5 & potential_impact <= 10, 'Moderate', 'Low'))))

pi_banc_da <- banc_da %>% 
  group_by(type) %>% 
  summarise(pi = mean(potential_impact, na.rm = TRUE)) %>% 
  mutate(potential_impact = ifelse(pi >= 20, 'Extreme', 
                              ifelse(pi > 10 & pi < 20, 'High',
                                     ifelse(pi > 5 & pi <= 10, 'Moderate', 'Low'))))
ad_banc_da <- adaptive_capacity %>% filter(wh == "Parc National du Banc d'Arguin") %>% select(-wh)
pi_banc_da_cc <-  pi_banc_da %>% filter(type == 'climate_change')
vul_banc_da <- full_join(pi_banc_da_cc, ad_banc_da, by = character())

vul_banc_da[sapply(vul_banc_da, is.character)] <- lapply(vul_banc_da[sapply(vul_banc_da, is.character)], 
as.factor)

vul_banc_da <- vul_banc_da %>% mutate(se_vu = ifelse(potential_impact == 'Low', 'Low',
                                      ifelse(potential_impact == 'Moderate' & ad_cap < 4, 'Moderate',
                                             ifelse(potential_impact == 'Moderate' & ad_cap == 4, 'Low',
                                                    ifelse(potential_impact == 'High' & ad_cap > 2, 'Moderate',
                                                           ifelse(potential_impact == 'High' & ad_cap < 3, 'High',
                                                                  ifelse(potential_impact == 'Extreme' & ad_cap == 4, 'Moderate',
                                                                         ifelse(potential_impact == 'Extreme' & ad_cap == 1,
                                                                                'Extreme', 'High'))))))))
dep_banc_da <- dependency %>% filter(wh == "Parc National du Banc d'Arguin") %>% select(-wh)
vul_banc_da <- full_join(vul_banc_da, dep_banc_da, by = character())

banc_da %>% kable()
pi_banc_da %>% kable()
vul_banc_da %>% kable()

#####################################################

tubbataha_s <- sensitivity %>% 
  filter(bioregion == 'b5', 
         threat %in% c('dr','sst','mh','lcbp','srba','srbp')) %>% 
   select(threat,sensitivity,sensitivity_q,type)

tubbataha_e_m <- exposure_m %>% 
  filter(wh == "Tubbataha Reefs Natural Park and World Heritage Site", 
         threat %in% c('dr','sst','mh','lcbp','srba','srbp')) %>% 
  ungroup() %>% 
  select(threat,exposure,exposure_q_m,type)


tubbataha_e_s <- exposure %>% 
  filter(bioregion == 'b5', 
         threat %in% c('dr','sst','mh','lcbp','srba','srbp')) %>% 
  rename(exposure_s = exposure) %>% 
  select(threat, exposure_s, exposure_q,type)


tubbataha <- full_join(tubbataha_s, tubbataha_e_m)
tubbataha <- full_join(tubbataha, tubbataha_e_s)
tubbataha <- tubbataha %>% mutate(potential_impact = exposure*sensitivity)

tubbataha <- tubbataha %>% 
    mutate(pi = ifelse(potential_impact >= 20, 'Extreme', 
                                     ifelse(potential_impact > 10 & potential_impact < 20, 'High',
                                            ifelse(potential_impact > 5 & potential_impact <= 10, 'Moderate', 'Low'))))

pi_tubbataha <- tubbataha %>% 
  group_by(type) %>% 
  summarise(pi = mean(potential_impact, na.rm = TRUE)) %>% 
  mutate(potential_impact = ifelse(pi >= 20, 'Extreme', 
                              ifelse(pi > 10 & pi < 20, 'High',
                                     ifelse(pi > 5 & pi <= 10, 'Moderate', 'Low'))))
ad_tubbataha <- adaptive_capacity %>% filter(wh == "Tubbataha Reefs Natural Park and World Heritage Site") %>% select(-wh)
pi_tubbataha_cc <-  pi_tubbataha %>% filter(type == 'climate_change')
vul_tubbataha <- full_join(pi_tubbataha_cc, ad_tubbataha, by = character())

vul_tubbataha[sapply(vul_tubbataha, is.character)] <- lapply(vul_tubbataha[sapply(vul_tubbataha, is.character)], 
as.factor)

vul_tubbataha <- vul_tubbataha %>% mutate(se_vu = ifelse(potential_impact == 'Low', 'Low',
                                      ifelse(potential_impact == 'Moderate' & ad_cap < 4, 'Moderate',
                                             ifelse(potential_impact == 'Moderate' & ad_cap == 4, 'Low',
                                                    ifelse(potential_impact == 'High' & ad_cap > 2, 'Moderate',
                                                           ifelse(potential_impact == 'High' & ad_cap < 3, 'High',
                                                                  ifelse(potential_impact == 'Extreme' & ad_cap == 4, 'Moderate',
                                                                         ifelse(potential_impact == 'Extreme' & ad_cap == 1,
                                                                                'Extreme', 'High'))))))))
dep_tubbataha <- dependency %>% filter(wh == "Tubbataha Reefs Natural Park and World Heritage Site") %>% select(-wh)
vul_tubbataha <- full_join(vul_tubbataha, dep_tubbataha, by = character())

tubbataha %>% kable()
pi_tubbataha %>% kable()
vul_tubbataha %>% kable()

###############################################################



wadden_s <- sensitivity %>% 
  filter(bioregion == 'b1', 
         threat %in% c('slr','sst','rain','lcbp','drg','ar')) %>% 
   select(threat,sensitivity,sensitivity_q,type)


wadden_e_m <- exposure_m %>% 
  filter(wh == "Wadden Sea", 
         threat %in% c('slr','sst','rain','lcbp','drg','ar')) %>% 
  ungroup() %>% 
  select(threat,exposure,exposure_q_m,type)

wadden_e_s <- exposure %>% 
  filter(bioregion == 'b1', 
         threat %in% c('slr','sst','rain','lcbp','drg','ar')) %>% 
  rename(exposure_s = exposure) %>% 
  select(threat, exposure_s, exposure_q,type)


wadden <- full_join(wadden_s, wadden_e_m)
wadden <- full_join(wadden, wadden_e_s)
wadden <- wadden %>% mutate(potential_impact = exposure*sensitivity)

wadden <- wadden %>% 
    mutate(pi = ifelse(potential_impact >= 20, 'Extreme', 
                                     ifelse(potential_impact > 10 & potential_impact < 20, 'High',
                                            ifelse(potential_impact > 5 & potential_impact <= 10, 'Moderate', 'Low'))))

pi_wadden <- wadden %>% 
  group_by(type) %>% 
  summarise(pi = mean(potential_impact, na.rm = TRUE)) %>% 
  mutate(potential_impact = ifelse(pi >= 20, 'Extreme', 
                              ifelse(pi > 10 & pi < 20, 'High',
                                     ifelse(pi > 5 & pi <= 10, 'Moderate', 'Low'))))
ad_wadden <- adaptive_capacity %>% filter(wh == "Wadden Sea") %>% select(-wh)
pi_wadden_cc <-  pi_wadden %>% filter(type == 'climate_change')
vul_wadden <- full_join(pi_wadden_cc, ad_wadden, by = character())

vul_wadden[sapply(vul_wadden, is.character)] <- lapply(vul_wadden[sapply(vul_wadden, is.character)], 
as.factor)

vul_wadden <- vul_wadden %>% mutate(se_vu = ifelse(potential_impact == 'Low', 'Low',
                                      ifelse(potential_impact == 'Moderate' & ad_cap < 4, 'Moderate',
                                             ifelse(potential_impact == 'Moderate' & ad_cap == 4, 'Low',
                                                    ifelse(potential_impact == 'High' & ad_cap > 2, 'Moderate',
                                                           ifelse(potential_impact == 'High' & ad_cap < 3, 'High',
                                                                  ifelse(potential_impact == 'Extreme' & ad_cap == 4, 'Moderate',
                                                                         ifelse(potential_impact == 'Extreme' & ad_cap == 1,
                                                                                'Extreme', 'High'))))))))
dep_wadden <- dependency %>% filter(wh == "Wadden Sea") %>% select(-wh)
vul_wadden <- full_join(vul_wadden, dep_wadden, by = character())

wadden %>% kable()
pi_wadden %>% kable()
vul_wadden %>% kable()
#######################################################


shark_bay_s <- sensitivity %>% 
  filter(bioregion == 'b6', 
         threat %in% c('mh','sst','ao','of','tra','srba')) %>% 
   select(threat,sensitivity,sensitivity_q,type)


shark_bay_e_m <- exposure_m %>% 
  filter(wh == "Shark Bay", 
         threat %in% c('mh','sst','ao','of','tra','srba')) %>% 
  ungroup() %>% 
  select(threat,exposure,exposure_q_m,type)


shark_bay_e_s <- exposure %>% 
  filter(bioregion == 'b6', 
         threat %in% c('mh','sst','ao','of','tra','srba')) %>% 
  rename(exposure_s = exposure) %>% 
  select(threat, exposure_s, exposure_q,type)

shark_bay <- full_join(shark_bay_s, shark_bay_e_m)
shark_bay <- full_join(shark_bay, shark_bay_e_s)
shark_bay <- shark_bay %>% mutate(potential_impact = exposure*sensitivity)

shark_bay <- shark_bay %>% 
    mutate(pi = ifelse(potential_impact >= 20, 'Extreme', 
                                     ifelse(potential_impact > 10 & potential_impact < 20, 'High',
                                            ifelse(potential_impact > 5 & potential_impact <= 10, 'Moderate', 'Low'))))

pi_shark_bay <- shark_bay %>% 
  group_by(type) %>% 
  summarise(pi = mean(potential_impact, na.rm = TRUE)) %>% 
  mutate(potential_impact = ifelse(pi >= 20, 'Extreme', 
                              ifelse(pi > 10 & pi < 20, 'High',
                                     ifelse(pi > 5 & pi <= 10, 'Moderate', 'Low'))))
ad_shark_bay <- adaptive_capacity %>% filter(wh == "Shark Bay") %>% select(-wh)
pi_shark_bay_cc <-  pi_shark_bay %>% filter(type == 'climate_change')
vul_shark_bay <- full_join(pi_shark_bay_cc, ad_shark_bay, by = character())

vul_shark_bay[sapply(vul_shark_bay, is.character)] <- lapply(vul_shark_bay[sapply(vul_shark_bay, is.character)], 
as.factor)

vul_shark_bay <- vul_shark_bay %>% mutate(se_vu = ifelse(potential_impact == 'Low', 'Low',
                                      ifelse(potential_impact == 'Moderate' & ad_cap < 4, 'Moderate',
                                             ifelse(potential_impact == 'Moderate' & ad_cap == 4, 'Low',
                                                    ifelse(potential_impact == 'High' & ad_cap > 2, 'Moderate',
                                                           ifelse(potential_impact == 'High' & ad_cap < 3, 'High',
                                                                  ifelse(potential_impact == 'Extreme' & ad_cap == 4, 'Moderate',
                                                                         ifelse(potential_impact == 'Extreme' & ad_cap == 1,
                                                                                'Extreme', 'High'))))))))
dep_shark_bay <- dependency %>% filter(wh == "Shark Bay") %>% select(-wh)
vul_shark_bay <- full_join(vul_shark_bay, dep_shark_bay, by = character())

shark_bay %>% kable()
pi_shark_bay %>% kable()
vul_shark_bay %>% kable()


potential_impacts <- rbind(pi_aldabra_cc, pi_belize_cc, pi_everglades_cc,pi_gbr_cc,pi_high_coast_cc, pi_ibiza_cc,pi_new_cal_cc, pi_lord_howe_cc, 
      pi_ningaloo_cc, pi_banc_da_cc, pi_tubbataha_cc, pi_wadden_cc, pi_shark_bay_cc) %>% mutate(wh = c('Aldabra Atoll', 
      'Belize Barrier Reef Reserve System', 
      'Everglades National Park', 
      'Great Barrier Reef', 
      'High Coast Kvarken Archipelago', 
      'Ibiza, Biodiversity and Culture',
      'Lagons de Nouvelle-Calédonie', 
      'Lord Howe Island Group', 
      'Ningaloo', 
      "Parc National du Banc d' Arguin", 
      'Tubbataha Reefs Natural Park',
      'Wadden Sea',
      'Shark Bay')) %>% arrange(-pi)

human_potential_impacts <- rbind(pi_aldabra, 
                                 pi_belize, 
                                 pi_everglades,
                                 pi_gbr,
                                 pi_high_coast, 
                                 pi_ibiza,
                                 pi_new_cal, 
                                 pi_lord_howe, 
                                 pi_ningaloo, 
                                 pi_banc_da, 
                                 pi_tubbataha, 
                                 pi_wadden, 
                                 pi_shark_bay) %>% 
  filter(type == 'human') %>% 
  mutate(wh = c('Aldabra Atoll',
                'Belize Barrier Reef Reserve System', 
                'Everglades National Park',
                'Great Barrier Reef',
                'High Coast Kvarken Archipelago', 
                'Ibiza, Biodiversity and Culture','Lagons de Nouvelle-Calédonie',
                'Lord Howe Island Group',
                'Ningaloo',
                "Parc National du Banc d' Arguin",
                'Tubbataha Reefs Natural Park',
                'Wadden Sea',
                'Shark Bay')) %>% 
  arrange(-pi)


vulnerability_WH <- rbind(vul_aldabra, 
      vul_belize, 
      vul_everglades,
      vul_gbr,
      vul_high_coast, 
      vul_ibiza,
      vul_new_cal, 
      vul_lord_howe, 
      vul_ningaloo, 
      vul_banc_da, 
      vul_tubbataha, 
      vul_wadden, 
      vul_shark_bay) %>% 
  mutate(wh = c('Aldabra Atoll',
                'Belize Barrier Reef Reserve System',
                'Everglades National Park', 
                'Great Barrier Reef', 
                'High Coast Kvarken Archipelago', 
                'Ibiza, Biodiversity and Culture',
                'Lagons de Nouvelle-Calédonie', 
                'Lord Howe Island Group',
                'Ningaloo', 
                "Parc National du Banc d' Arguin", 
                'Tubbataha Reefs Natural Park', 
                'Wadden Sea',
                'Shark Bay')) %>% 
  mutate(se_vu = factor(se_vu, levels = c('Low','Moderate','High'))) %>% 
  mutate(wh_vul = ifelse(ou_dep == 1, 'Low',
                                            ifelse(ou_dep == 2 & (se_vu == 'Low'| se_vu == 'Moderate'), 'Low',
                                                   ifelse(ou_dep == 2 & (se_vu == 'High'| se_vu == 'Extreme'), 'Moderate',
                                                          ifelse(ou_dep == 3 & se_vu == 'Low', 'Low',
                                                                 ifelse(ou_dep == 3 & se_vu == 'Moderate', 'Moderate',
                                                                        ifelse(ou_dep == 3 & (se_vu == 'High'| se_vu == 'Extreme'), 'High',
                                                                               ifelse(ou_dep == 4 & se_vu == 'Low', 'Low',
                                                                                      ifelse(ou_dep == 4 & se_vu == 'Moderate', 'Moderate',
                                                                                             ifelse(ou_dep == 4 & se_vu == 'High', 'High',
                                                                                                    ifelse(ou_dep == 4 & se_vu == 'Extreme', 'Extreme',
                                                                                                           ifelse(ou_dep == 5 & se_vu == 'Low', 'Low',
                                                                                                                  ifelse(ou_dep == 5 & se_vu == 'Moderate', 'Moderate',
                                                                                                                         ifelse(ou_dep == 5 & se_vu == 'High', 'High', 'Extreme')))))))))))))) %>% arrange(desc(wh_vul))



```

Top:Potential impact, adaptive capacity, seagrass vulnerability, OUV dependency, community dependency and WH Vulnerability for 13 WH seagrass habitats

Bottom: potential impact from anthropogenic threats

```{r 8, echo=FALSE}
vulnerability_WH1 <- vulnerability_WH[,c(11,3,5,6,9,10,12)]
vulnerability_WH1 %>% 
  mutate(se_vu = ordered(se_vu, levels = c('High', 'Moderate', 'Low'))) %>% 
  arrange(se_vu) %>% kable()
table5 <- vulnerability_WH1 %>% 
  mutate(se_vu = ordered(se_vu, levels = c('High', 'Moderate', 'Low'))) %>% 
  arrange(se_vu)

human_potential_impacts %>% select(potential_impact, wh) %>%  kable()
```


# Outliers and Consensus among survey particpants
## Cluster analysis of responses among seagrass scientists

```{r consensus, echo=FALSE}
# Hierarchical analysis with exposure values
set.seed(786)

# remove column type.of.seeds
exp_label <- ex_df_long$bioregion
exp_df <- as.data.frame(ex_df_long$value) 

# Scale values with mean 0 and sd 1
exp_df_sc <- as.data.frame(scale(exp_df))
exp_df_sc <- na.omit(exp_df_sc)

# Create a distance matrix - euclidian because of continous variables
dist_mat <- dist(exp_df_sc, method = 'euclidean')

# Build dendogram and decide the linkage method
hclust_avg <- hclust(dist_mat, method = 'average')
#plot(hclust_avg)

# Cut the nuber of clusters based on the number of groups
cut_avg <- cutree(hclust_avg, k = 6)

# Visualize clusters with boxes
#plot(hclust_avg)
#rect.hclust(hclust_avg , k = 6, border = 2:6)
#abline(h = 3, col = 'red')


# Visualize clusters with different colors

avg_dend_obj <- as.dendrogram(hclust_avg)
avg_col_dend <- color_branches(avg_dend_obj, k = 6)
plot(avg_col_dend)

# Append cluster back into the dataset
exp_df <- na.omit(exp_df)
exp_df_cl <- mutate(exp_df, cluster = cut_avg)
#count(exp_df_cl,cluster)





```

Coefficients of variation in exposure scores among scientists

Table 1: per bioregion

Table 2: per threat

Table 3: per index

Table 4: per type of threat


```{r 10, echo=FALSE}
# Coefficient of variation of exposure scores among scientists
ex_df_long %>% filter(!is.na(value)) %>%  
    group_by(bioregion) %>% 
    summarise(CV = (sd(value)/mean(value))*100) %>% arrange(-CV) %>% kable()

ex_df_long %>% filter(!is.na(value)) %>%  
    group_by(threat) %>% 
    summarise(CV = (sd(value)/mean(value))*100) %>% arrange(-CV) %>% kable()

ex_df_long %>% filter(!is.na(value)) %>% 
  group_by(index) %>% 
  summarise(CV = (sd(value)/mean(value)*100)) %>% arrange(-CV) %>% kable()

ex_df_long %>% filter(!is.na(value)) %>%
  mutate(type = ifelse(threat == 'mh'|threat == 'storm'|threat == 'dr'|threat == 'slr'|threat == 'sst'|threat == 'rain'|threat == 'ao','climate_change','human' )) %>% 
  group_by(type) %>% 
  summarise(CV = (sd(value)/mean(value)*100)) %>% arrange(-CV) %>% kable()
```

Coefficients of variation in sensitivity scores among scientists

Table 1: per bioregion

Table 2: per threat

Table 3: per index

Table 4: per type of threat


```{r 11, echo=FALSE}
# Coefficient of variation of sensitivity
sens_df_long %>% filter(!is.na(value)) %>%  
    group_by(bioregion) %>% 
    summarise(CV = (sd(value)/mean(value))*100) %>% arrange(-CV) %>% kable()

sens_df_long %>% filter(!is.na(value)) %>%  
    group_by(threat) %>% 
    summarise(CV = (sd(value)/mean(value))*100) %>% arrange(-CV) %>% kable()

sens_df_long %>% filter(!is.na(value)) %>% 
  group_by(index) %>% 
  summarise(CV = (sd(value)/mean(value)*100)) %>% arrange(-CV) %>% kable()

sens_df_long %>% filter(!is.na(value)) %>%
  mutate(type = ifelse(threat == 'mh'|threat == 'storm'|threat == 'dr'|threat == 'slr'|threat == 'sst'|threat == 'rain'|threat == 'ao','climate_change','human' )) %>% 
  group_by(type) %>% 
  summarise(CV = (sd(value)/mean(value)*100)) %>% arrange(-CV) %>% kable()
```

Coefficients of variation in certainty scores among scientists

Table 1: per bioregion

Table 2: per threat

Table 3: per index

Table 4: per type of threat

```{r 12, echo=FALSE}
# Coefficient of variation of certainty
cer_long %>% 
    group_by(bioregion) %>% 
    summarise(CV = (sd(certainty)/mean(certainty))*100) %>% arrange(-CV) %>% kable()

cer_long %>% 
    group_by(threat) %>% 
    summarise(CV = (sd(certainty)/mean(certainty))*100) %>% arrange(-CV) %>% kable()

cer_long %>% 
    group_by(index) %>% 
    summarise(CV = (sd(certainty)/mean(certainty))*100) %>% arrange(-CV) %>% kable()
```

Coefficients of variation in exposure scores among site managers

Table 1: per WH property

Table 2: per threat

Table 3: per index

Table 4: per type of threat


```{r 13, echo=FALSE}
# Coeffiecient of variation managers

managers_summary_long %>% filter(!is.na(value)) %>%  
    group_by(wh) %>% 
    summarise(CV = (sd(value)/mean(value))*100) %>% arrange(-CV) %>% kable()

managers_summary_long %>% filter(!is.na(value)) %>% 
    group_by(threat) %>% 
    summarise(CV = (sd(value)/mean(value))*100) %>% arrange(-CV) %>% kable()

managers_summary_long %>% filter(!is.na(value)) %>%  
    group_by(index) %>% 
    summarise(CV = (sd(value)/mean(value))*100) %>% arrange(-CV) %>% kable()

managers_summary_long %>% filter(!is.na(value)) %>%
  mutate(type = ifelse(threat == 'mh'|threat == 'storm'|threat == 'dr'|threat == 'slr'|threat == 'sst'|threat == 'rain'|threat == 'ao','climate_change','human' )) %>% 
  group_by(type) %>% 
  summarise(CV = (sd(value)/mean(value)*100)) %>% arrange(-CV) %>% kable()
```

# ANOVA and Linear regression
## Anova test of exposure values across bioregion

```{r anova1, echo=FALSE}
exp_anova <- aov(exposure ~ bioregion, data = exposure)
summary(exp_anova)
# Homogeneity of variance
leveneTest(exposure ~ bioregion, data = exposure)
# Normality
#plot(exp_anova, 2)
# Extract the residuals
aov_residuals <- residuals(object = exp_anova )
# Run Shapiro-Wilk test
shapiro.test(x = aov_residuals )
TukeyHSD(exp_anova)

## Threats
exp_anova1 <- aov(exposure ~ threat, data = exposure)
summary(exp_anova1)
# Homogeneity of variance
leveneTest(exposure ~ threat, data = exposure)
# Normality
#plot(exp_anova1, 2)
# Extract the residuals
aov_residuals1 <- residuals(object = exp_anova1 )
# Run Shapiro-Wilk test
shapiro.test(x = aov_residuals1 )


```

## Anova test of sensitivity values across bioregion

```{r anova2, echo=FALSE, warning=FALSE}
# Sensitivty
sens_anova <- aov(sensitivity ~ bioregion, data = sensitivity)
summary(sens_anova)
# Homogeneity of variance
leveneTest(sensitivity ~ bioregion, data = sensitivity)
# Normality
plot(sens_anova, 2)
# Extract the residuals
aov_residuals3 <- residuals(object = sens_anova )
# Run Shapiro-Wilk test
shapiro.test(x = aov_residuals3)

kruskal.test(sensitivity ~ bioregion, data = sensitivity)
pairwise.wilcox.test(sensitivity$sensitivity, sensitivity$bioregion,
                 p.adjust.method = "BH")

sens_anova1 <- aov(sensitivity ~ threat, data = sensitivity)
summary(sens_anova1)
# Homogeneity of variance
leveneTest(sensitivity ~ threat, data = sensitivity)
# Normality
plot(sens_anova1, 2)
# Extract the residuals
aov_residuals2 <- residuals(object = sens_anova1 )
# Run Shapiro-Wilk test
shapiro.test(x = aov_residuals2)

TukeyHSD(sens_anova1)
```
## Potential impact
```{r}
pi_anova <- aov(potential_impact ~ threat, data = pi_df1)
summary(pi_anova)
# Homogeneity of variance
leveneTest(potential_impact ~ threat, data = pi_df1)
# Normality
plot(pi_anova, 2)
# Extract the residuals
pi_aov_residuals <- residuals(object = pi_anova )
# Run Shapiro-Wilk test
shapiro.test(x = pi_aov_residuals)

TukeyHSD(pi_anova)
```



## Linear regression between sample size and mean
 
```{r linear, echo=FALSE, message=FALSE, warning=FALSE}
df <- scientist[,33:1417]
column_means <- colMeans(df, na.rm = TRUE)
sample_size <- apply(X=df,2,FUN=function(x) length(which(!is.na(x))))

linear_df <- as.data.frame(cbind(column_means, sample_size))
# Check for normality
#linear_df %>% ggplot(aes(y = column_means)) + geom_boxplot()
# Homogeneity of variance
linear_df %>% ggplot(aes(x = sample_size, 
                         y = column_means)) + geom_point() + 
  geom_smooth(method = 'lm')
summary(lm(column_means ~ sample_size, data = linear_df))
```


## Linear regression between standard errors and potential impac index and stressor type

The standard error for exposure scores of human threats are statistically higher than for climate change threats.
If we remove interactions, the same difference appear within sensitivity scores 
Exposure scores SE are higher than for sensitivity scores in the additive model 
If scientists were responding for climate change, the variance among their responses was not stastically different between type of threats
Additionally, if scientists were responding for sensitivity, no difference between climate change and human
compare different types per index or difference index per type

_Main results_: 
Certainty about climate change is higher than human impacts 
Sensitivity to climate change is higher

```{r linear_m, echo=FALSE, message=FALSE, warning=FALSE}
source('linear_model_exposure.R')
lm_plot
lm_plot1
summary(exp_sens_lm)
summary(exp_sens_lm1)
exp_sens_lm %>% emmeans(~index|type) %>% regrid() %>% pairs() %>% confint
exp_sens_lm %>% emmeans(~type|index) %>% regrid() %>% pairs() %>% confint

exp_sens_lm1 %>% emmeans(~index|type) %>% regrid() %>% pairs() %>% confint
exp_sens_lm1 %>% emmeans(~type|index) %>% regrid() %>% pairs() %>% confint
AICc(exp_sens_lm0,exp_sens_lm1,exp_sens_lm2,exp_sens_lm3)
Figure6 <- ggarrange(lm_plot, lm_plot1,
          labels = c('A','B'),
          label.x = 0.9,
          ncol = 1, nrow = 2)
```

## Experience of scientists

```{r}
# Subset full response
cazzino <- function(x, n){
y <- x[rowSums(is.na(x)) < (ncol(x) - n),]
z <- prop.table(table(y$experience))
return(z %>% kable())
}

cazzino(scientist, 32)
```


